CREATE OR REPLACE PROCEDURE INGESTION.PROC_CATASTO_GALLERIE_STORICO
AS
	NOW timestamp;
BEGIN

SELECT systimestamp INTO NOW FROM dual;

UPDATE
	INGESTION.CATASTO_GALLERIE_STORICO s
SET
	s.DATA_FINE = NOW
WHERE
	(s.TIPOPERA, s.IDOPERA, s.CODICE)
IN (
	SELECT
		o.TIPOPERA, o.IDOPERA, o.CODICE
	FROM
		INGESTION.CATASTO_GALLERIE_OPERATION_NEW o
	WHERE
		o.OPERATION IN ('U', 'D')
)
AND s.DATA_FINE = TO_TIMESTAMP('31-12-9999 23:59:59', 'DD-MM-YYYY HH24:MI:SS');

INSERT INTO INGESTION.CATASTO_GALLERIE_STORICO
SELECT
	T.TIPOPERA,
	T.IDOPERA,
	T.CODICE,
	T.NOMOPERA,
	T.COMUNE,
	T.PROVINCIA,
	T.COMPART,
	T.COMPARTIMENTO,
	T.PROVENIENZADATO,
	T.CODSS,
	T.PRO_IN,
	T.PRO_FI,
	T.CODSSNEW_I,
	T.KMNEWINMETRI_I,
	T.ANNO_APERTURA,
	T.LUNGHEZZA,
	T.TIPO_GALLERIA,
	T.COORDZ_I,
	T.LATITUDINE_I,
	T.LONGITUDINE_I,
	T.COORDZ_F,
	T.LATITUDINE_F,
	T.LONGITUDINE_F,
	T.ILLUMINAZIONE_ARTIFICIALE,
	T.VENTILAZIONE_ARTIFICIALE,
	T.URL_FORM,
	T.NOTE,
	SDO_UTIL.from_WKBGEOMETRY(T.GEOM2),
	T.FLAG,
	T.DATA_INIZIO_VALIDITA,
	T.DATA_FINE_VALIDITA,
	NOW,
	TO_TIMESTAMP('31-12-9999 23:59:59', 'DD-MM-YYYY HH24:MI:SS')
FROM
	INGESTION.CATASTO_GALLERIE_OPERATION_NEW T
WHERE T.OPERATION IN ('I', 'U');



END PROC_CATASTO_GALLERIE_STORICO;
