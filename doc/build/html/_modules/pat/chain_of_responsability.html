


<!DOCTYPE html>

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pat.chain_of_responsability &#8212; PAT 0.1.0 documentazione</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="index" title="Indice" href="../../genindex.html" />
    <link rel="search" title="Cerca" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigazione</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Indice generale"
             accesskey="I">indice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Indice del modulo Python"
             >moduli</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">PAT 0.1.0 documentazione</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Codice del modulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pat.chain_of_responsability</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Codice sorgente per pat.chain_of_responsability</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">pat.class_tool</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pat.connector</span> <span class="kn">import</span> <span class="n">Connector</span>
<span class="kn">from</span> <span class="nn">pat.db_utility</span> <span class="kn">import</span> <span class="n">DbLog</span>
<span class="kn">from</span> <span class="nn">pat.utility</span> <span class="kn">import</span> <span class="n">Common</span><span class="p">,</span> <span class="n">Spark</span><span class="p">,</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Json</span><span class="p">,</span> <span class="n">PatValidationError</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>


<div class="viewcode-block" id="MemoryMap"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap">[documenti]</a><span class="k">class</span> <span class="nc">MemoryMap</span><span class="p">:</span>
    <span class="n">map_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mappa condivisa tra tutti gli anelli</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MemoryMap.hget"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.hget">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hget</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">def_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Ritorna valore alla chiave corrispondente</span>

<span class="sd">            Args:</span>
<span class="sd">                args: lista di chiavi ricorsive [arg1,arg2,arg3,...]</span>
<span class="sd">                def_val: valore di default</span>
<span class="sd">            Return:</span>
<span class="sd">                Any: valore di map[arg1][arg2][arg...]</span>
<span class="sd">            :raise:</span>
<span class="sd">                ritorna def_val</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">def_val</span></div>

<div class="viewcode-block" id="MemoryMap.hset"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.hset">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hset</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Setta valore alla chiave corrispondente</span>

<span class="sd">            Args:</span>
<span class="sd">                args: lista di chiavi ricorsive [arg1,arg2,arg3,...]</span>
<span class="sd">                overwrite: sovrascrivi valore se presente</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">list_</span> <span class="o">=</span> <span class="n">args</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">list_</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">last_key</span> <span class="o">=</span> <span class="n">list_</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">map_tmp</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span>
        <span class="k">for</span> <span class="n">l_</span> <span class="ow">in</span> <span class="n">list_</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l_</span> <span class="ow">in</span> <span class="n">map_tmp</span><span class="p">:</span>
                <span class="n">map_tmp</span> <span class="o">=</span> <span class="n">map_tmp</span><span class="p">[</span><span class="n">l_</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">map_tmp</span><span class="p">[</span><span class="n">l_</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">map_tmp</span> <span class="o">=</span> <span class="n">map_tmp</span><span class="p">[</span><span class="n">l_</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">last_key</span> <span class="ow">in</span> <span class="n">map_tmp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Key already in use : </span><span class="si">{</span><span class="n">list_</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">map_tmp</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="MemoryMap.set"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.set">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="n">id_transaction</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">[</span><span class="n">id_transaction</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="MemoryMap.get"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.get">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">id_transaction</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">id_transaction</span> <span class="ow">in</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">[</span><span class="n">id_transaction</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">[</span><span class="n">id_transaction</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MemoryMap.set_id_transaction"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.set_id_transaction">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_id_transaction</span><span class="p">(</span><span class="n">id_transaction</span><span class="p">):</span>
        <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">[</span><span class="n">id_transaction</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="MemoryMap.get_id_transaction"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.MemoryMap.get_id_transaction">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_id_transaction</span><span class="p">(</span><span class="n">id_transaction</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">id_transaction</span> <span class="ow">in</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">map_</span><span class="p">[</span><span class="n">id_transaction</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="BaseRing"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseRing">[documenti]</a><span class="k">class</span> <span class="nc">BaseRing</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interfaccia Base dei vari anelli.</span>
<span class="sd">    Si deve reimplementare il metodo run</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">id_transaction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Costruttore BaseRing</span>
<span class="sd">        Args:</span>
<span class="sd">            option: contiene le varie opzioni per costruire l&#39;anello</span>
<span class="sd">            id_transaction: id della transazione</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option</span> <span class="o">=</span> <span class="n">option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span> <span class="o">=</span> <span class="n">id_transaction</span>

<div class="viewcode-block" id="BaseRing.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseRing.run">[documenti]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implementazione dell&#39;anello</span>

<span class="sd">        Args:</span>
<span class="sd">            req: input dell&#39;anello</span>
<span class="sd">        Return:</span>
<span class="sd">            Any: output anello</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="DataAcquisitionRead"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionRead">[documenti]</a><span class="k">class</span> <span class="nc">DataAcquisitionRead</span><span class="p">(</span><span class="n">BaseRing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Anello per lettura input dati da sorgente</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">id_transaction</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">id_transaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_schema</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DataAcquisitionRead.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionRead.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validazione config json relativo</span>

<span class="sd">        .. describe:: Parameteri pre-esistenti obbligatori:</span>
<span class="sd">        :param option[id_source]: identificativo sorgente</span>
<span class="sd">        :param option[url]: indirizzo sorgente dati</span>
<span class="sd">        :param option[param]: parametri di connessione</span>
<span class="sd">        :param id_transaction: id della transazione</span>

<span class="sd">        :return: True se json corretto altrimenti False, Descrizione Errore</span>
<span class="sd">        :rtype: Bool, String</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id_source&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;not id_source or url or param in option json&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">Connector</span><span class="o">.</span><span class="n">connector_map</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;url protocol protocol don&#39;t handled&quot;</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="DataAcquisitionRead.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionRead.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param req:</span>
<span class="sd">           :type req: None</span>
<span class="sd">           :return: Lista di Oggetti Source</span>
<span class="sd">           :rtype: list(Source)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataAcquisitionRead start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_insert</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_start</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataAcquisitionRead&quot;</span>
            <span class="p">)</span>
            <span class="n">continue_if_except</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;continue_if_except&quot;</span><span class="p">)</span>
            <span class="n">connector</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">()</span>
            <span class="n">source_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">option_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
            <span class="n">spark</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;spark&quot;</span><span class="p">)</span>
            <span class="n">spark_</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">spark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">spark_</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">spark</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">option_list</span><span class="p">:</span>
                <span class="n">id_source</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;id_source&quot;</span><span class="p">)</span>
                <span class="n">connector_read</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                    <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">),</span>
                    <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">),</span>
                    <span class="n">spark</span><span class="o">=</span><span class="n">spark_</span>
                <span class="p">)</span>

                <span class="n">connector_read_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">connector_read</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cr</span> <span class="ow">in</span> <span class="n">connector_read_list</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">Source</span><span class="p">()</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">id_source</span><span class="p">(</span><span class="n">id_source</span><span class="p">)</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
                    <span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>
                    <span class="n">source_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                    <span class="n">filename_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filename_list</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="n">Common</span><span class="o">.</span><span class="n">validateFile</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">schema</span><span class="o">=</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;schema&quot;</span><span class="p">),</span>
                                                <span class="nb">type</span><span class="o">=</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">exit_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="n">continue_if_except</span><span class="p">:</span>
                                <span class="c1"># eliminazione della lista di source validi</span>
                                <span class="n">source_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">source_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;filename:</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> is not a valid file. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_file_insert</span><span class="p">(</span>
                                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                                <span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span>
                                <span class="n">exit_code</span><span class="o">=</span><span class="n">exit_code</span>
                            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_update</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_end</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataAcquisitionRead&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataAcquisitionRead end&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">source_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionRead exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="DataAcquisitionWrite"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionWrite">[documenti]</a><span class="k">class</span> <span class="nc">DataAcquisitionWrite</span><span class="p">(</span><span class="n">BaseRing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Anello per scrittura input dati su hdfs, bypassabile cancellando la chiave:</span>
<span class="sd">        [&quot;ingestion&quot;][&quot;DataAcquisitionWrite&quot;] da conf.json</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataAcquisitionWrite.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionWrite.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DataAcquisitionWrite.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataAcquisitionWrite.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param req: Lista di Oggetti Source</span>
<span class="sd">           :type req: list(Source)</span>
<span class="sd">           :return: Lista di Oggetti Source</span>
<span class="sd">           :rtype: list(Source)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataAcquisitionWrite start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_insert</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_start</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataAcquisitionWrite&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">connector</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">()</span>
            <span class="n">option_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
            <span class="n">source_list</span> <span class="o">=</span> <span class="n">req</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">option_list</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">)</span>
                <span class="n">id_source</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;id_source&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">source_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">id_source</span> <span class="o">==</span> <span class="n">source</span><span class="o">.</span><span class="n">id_source</span><span class="p">():</span>
                        <span class="n">data_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>
                        <span class="n">filename_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>

                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)):</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">data_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                            <span class="n">source_delete</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span> <span class="s2">&quot;source_delete&quot;</span><span class="p">)</span>

                            <span class="n">source_name</span> <span class="o">=</span> <span class="n">filename_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">get_filename_from_url</span><span class="p">(</span>
                                <span class="n">source_name</span><span class="p">,</span>
                                <span class="n">level</span><span class="o">=</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span> <span class="s2">&quot;source_level&quot;</span><span class="p">),</span>
                                <span class="n">folder</span><span class="o">=</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">,</span> <span class="s2">&quot;source_folder&quot;</span><span class="p">)</span>
                            <span class="p">)</span>

                            <span class="n">destination_name</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite source_name : </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite filename : </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite write : </span><span class="si">{</span><span class="n">destination_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">connector</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="n">destination_name</span><span class="p">,</span>
                                <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">),</span>
                                <span class="n">data</span>
                            <span class="p">)</span>

                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite source_delete : </span><span class="si">{</span><span class="n">source_delete</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">source_delete</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite delete : </span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">connector</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                                    <span class="n">source_name</span><span class="p">,</span>
                                    <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">)</span>
                                <span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_file_update</span><span class="p">(</span>
                                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                                <span class="n">filename</span><span class="o">=</span><span class="n">source_name</span><span class="p">,</span>
                                <span class="n">filepath</span><span class="o">=</span><span class="n">destination_name</span>
                            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_update</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_end</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataAcquisitionWrite&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataAcquisitionWrite end&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">req</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataAcquisitionWrite exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="DataPreProcess"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataPreProcess">[documenti]</a><span class="k">class</span> <span class="nc">DataPreProcess</span><span class="p">(</span><span class="n">BaseRing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Anello per preprocessamento input , bypassabile cancellando la chiave:</span>
<span class="sd">        [&quot;ingestion&quot;][&quot;DataPreProcess&quot;] da conf.json</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataPreProcess.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataPreProcess.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DataPreProcess.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataPreProcess.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param req: Lista di Oggetti Source</span>
<span class="sd">           :type req: list(Source)</span>
<span class="sd">           :return: Lista di Oggetti Source</span>
<span class="sd">           :rtype: list(Source)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataPreProcess start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_insert</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_start</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataPreProcess&quot;</span>
            <span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_process</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_update</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_end</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataPreProcess&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataPreProcess end&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataPreProcess exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="DataPreProcess.pre_process"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataPreProcess.pre_process">[documenti]</a>    <span class="k">def</span> <span class="nf">pre_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">req</span></div></div>


<div class="viewcode-block" id="DataProcess"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataProcess">[documenti]</a><span class="k">class</span> <span class="nc">DataProcess</span><span class="p">(</span><span class="n">BaseRing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Anello per processamento input , bypassabile cancellando la chiave:</span>
<span class="sd">        [\\&quot;ingestion\\&quot;][\\&quot;DataProcess\\&quot;] da conf.json</span>
<span class="sd">        La funzione process(req) dovr essere riscritta nel proprio script custom</span>
<span class="sd">        e riassegnarla come nell&#39;esempio:</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">            class ScriptProcess:</span>
<span class="sd">                def process(self, req):</span>
<span class="sd">                    df= spark.createDataframe(req.data)</span>
<span class="sd">                    storable = Storable()</span>
<span class="sd">                    storable.data(df)</span>
<span class="sd">                    storable.id_storable(&quot;impala&quot;)</span>
<span class="sd">                    return [storable]</span>
<span class="sd">            DataProcess.process=ScriptProcess.process</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataProcess.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataProcess.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DataProcess.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataProcess.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param req: Lista di Oggetti Source</span>
<span class="sd">           :type req: list(Source)</span>
<span class="sd">           :return: Lista di Oggetti Storable</span>
<span class="sd">           :rtype: list(Storable)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataProcess start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_insert</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_start</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataProcess&quot;</span>
            <span class="p">)</span>

            <span class="n">storable_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_update</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_end</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataProcess&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataProcess end&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">storable_list</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataProcess exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="DataProcess.process"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataProcess.process">[documenti]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">req</span></div></div>


<div class="viewcode-block" id="DataStoring"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataStoring">[documenti]</a><span class="k">class</span> <span class="nc">DataStoring</span><span class="p">(</span><span class="n">BaseRing</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Anello per memorizzazione dei dati.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataStoring.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataStoring.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DataStoring.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.DataStoring.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param req: Lista di Oggetti Source</span>
<span class="sd">           :type req: list(Source)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataStoring start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_insert</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_start</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataStoring&quot;</span>
            <span class="p">)</span>

            <span class="n">connector</span> <span class="o">=</span> <span class="n">Connector</span><span class="p">()</span>
            <span class="n">option_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
            <span class="n">storable_list</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">option_list</span><span class="p">:</span>
                <span class="n">id_storable</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;id_storable&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">storable</span> <span class="ow">in</span> <span class="n">storable_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">id_storable</span> <span class="o">==</span> <span class="n">storable</span><span class="o">.</span><span class="n">id_storable</span><span class="p">():</span>
                        <span class="n">connector</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">),</span>
                            <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;param&quot;</span><span class="p">),</span>
                            <span class="n">storable</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
                        <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_operation_update</span><span class="p">(</span>
                <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
                <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date_end</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;DataStoring&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DataStoring end&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataStoring exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="BaseChain"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseChain">[documenti]</a><span class="k">class</span> <span class="nc">BaseChain</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe BaseChain</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseChain.rings_list"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseChain.rings_list">[documenti]</a>    <span class="k">def</span> <span class="nf">rings_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Funzione implementata nel :py:class:ManagerChain</span>
<span class="sd">        :return: lista di Classi BaseRing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rings_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">          :param rings_list: Lista di Oggetti</span>
<span class="sd">          :type req: list(Object(BaseRing))</span>
<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rings_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings_list</span><span class="p">()</span>

<div class="viewcode-block" id="BaseChain.run"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseChain.run">[documenti]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># chain = [c() for c in self.rings]</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Esecuzione flusso (catena) mediante i run dei singoli anelli.</span>
<span class="sd">        :return: Risposta dell&#39;ultimo anello.</span>
<span class="sd">        :raise: Se fallisce la funzione validate_config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">req</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Controllo config singolo anello</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validate_config</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="BaseChain.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.BaseChain.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validazione config dei singoli anelli</span>

<span class="sd">        :raise: Se la singola validazione del config json dell&#39;anello non  corretta</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rings</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">validate_config</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PatValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> has config json not consistent. </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ManagerChain"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain">[documenti]</a><span class="k">class</span> <span class="nc">ManagerChain</span><span class="p">(</span><span class="n">BaseChain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classe gestore Chain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># rings deve essere automaticamente dal conf.json</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">           :param conf_json: File json di configurazione</span>
<span class="sd">           :type req: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">conf_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_json</span> <span class="o">=</span> <span class="s2">&quot;./conf.json&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_json</span> <span class="o">=</span> <span class="n">conf_json</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_json</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="c1"># json_file.read().replace(&quot;%Y&quot;,&quot;2000&quot;)</span>
            <span class="c1"># config = json.load(json_file, object_hook=lambda d: namedtuple(&#39;Config&#39;, d.keys())(*d.values()))</span>
            <span class="n">file_str</span> <span class="o">=</span> <span class="n">json_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">file_str</span> <span class="o">=</span> <span class="n">file_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">file_str</span> <span class="o">=</span> <span class="n">Common</span><span class="o">.</span><span class="n">replace_time</span><span class="p">(</span><span class="n">file_str</span><span class="p">)</span>

        <span class="c1"># config = json.loads(file_str)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">file_str</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">Logger</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;log_level&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="ManagerChain.execute"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.execute">[documenti]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Esecuzione Flusso Chain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ManagerChain start&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_var</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ManagerChain exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exc_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">exc_message</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                records = self.db_log.select_log_exit_code(</span>
<span class="sd">                    type=exc_type,</span>
<span class="sd">                    message=exc_message</span>
<span class="sd">                )</span>
<span class="sd">                &#39;&#39;&#39;</span>

                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_exit_code_select</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">exc_type</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">exc_message</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_exit_code_insert</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">exc_type</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">exc_message</span>
                    <span class="p">)</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_exit_code_select</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">exc_type</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">exc_message</span>
                    <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ManagerChain exception : </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>  <span class="c1"># close spark, update log</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;end&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ManagerChain end&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerChain.rings_list"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.rings_list">[documenti]</a>    <span class="k">def</span> <span class="nf">rings_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determinazione delle Classi-Anello della chain in funzione della sezione ingestion nel config.json</span>

<span class="sd">        :return: Lista Classi-Anello</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># rings=list(eval(f&quot;{r}(config.{r})&quot;) for r in config._fields if r !=&quot;var&quot; )</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;ingestion&quot;</span><span class="p">):</span>
                <span class="n">option_</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;ingestion&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load custom ring : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;from script import </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>

                <span class="n">c</span> <span class="o">=</span> <span class="n">class_</span><span class="p">(</span><span class="n">option_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">)</span>
                <span class="n">rings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rings</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ManagerChain rings_list exception : </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="ManagerChain.init_var"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.init_var">[documenti]</a>    <span class="k">def</span> <span class="nf">init_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inizializzazione variabili del config.json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span> <span class="o">=</span> <span class="n">DbLog</span><span class="p">(</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">))</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="c1"># set start_time_env</span>
        <span class="n">start_time_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;START_TIME&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_time_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;START_TIME == </span><span class="si">{</span><span class="n">start_time_env</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time_env</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># set expiration_date</span>
        <span class="n">validity_minutes</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;validity_minutes&quot;</span><span class="p">)</span>
        <span class="n">expiration_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">validity_minutes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expiration_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">validity_minutes</span><span class="p">)</span>

        <span class="c1"># init spark</span>
        <span class="n">app_init_spark</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;init_spark&quot;</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">app_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">app_init_spark</span><span class="p">:</span>
            <span class="n">spark_conf</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;spark_conf&quot;</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="p">{})</span>
            <span class="n">spark</span> <span class="o">=</span> <span class="n">Spark</span><span class="p">(</span><span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="s2">&quot;app&quot;</span><span class="p">),</span> <span class="n">spark_conf</span><span class="p">)</span>
            <span class="n">app_id</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">get_application_id</span><span class="p">()</span>
            <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;spark&quot;</span><span class="p">,</span> <span class="n">spark</span><span class="p">)</span>

        <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;db_log&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">continue_if_except</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="s2">&quot;continue_if_except&quot;</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;continue_if_except&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">continue_if_except</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_insert</span><span class="p">(</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
            <span class="n">script</span><span class="o">=</span><span class="n">app_name</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">expiration_date</span><span class="o">=</span><span class="n">expiration_date</span><span class="p">,</span>
            <span class="n">app_id</span><span class="o">=</span><span class="n">app_id</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ManagerChain.end"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.end">[documenti]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># chiudere spark, update log</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Funzione di fine-esecuzione per chiudere la spark-session e aggiornare la tabella log della corretta/non corretta esecuzione</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End - ManagerChain&quot;</span><span class="p">)</span>
        <span class="n">spark</span><span class="p">:</span> <span class="n">Spark</span> <span class="o">=</span> <span class="n">MemoryMap</span><span class="o">.</span><span class="n">hget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span> <span class="s2">&quot;spark&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spark</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spark</span><span class="o">.</span><span class="n">get_spark_context</span><span class="p">():</span>
            <span class="n">spark</span><span class="o">.</span><span class="n">get_spark_context</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_log</span><span class="o">.</span><span class="n">log_update</span><span class="p">(</span>
            <span class="n">run_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_transaction</span><span class="p">,</span>
            <span class="n">execution_time</span><span class="o">=</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">exit_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exit_code</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ManagerChain.validate_config"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.validate_config">[documenti]</a>    <span class="k">def</span> <span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validazione config.json</span>

<span class="sd">        :raise: config.json non valido</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;ingestion&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PatValidationError</span><span class="p">(</span><span class="s2">&quot;Error in config.json: ingestion key not present&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManagerChain.end_ko"><a class="viewcode-back" href="../../pat.html#pat.chain_of_responsability.ManagerChain.end_ko">[documenti]</a>    <span class="k">def</span> <span class="nf">end_ko</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Ricerca veloce</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigazione</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Indice generale"
             >indice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Indice del modulo Python"
             >moduli</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">PAT 0.1.0 documentazione</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Codice del modulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pat.chain_of_responsability</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Giuseppe Ventura - Almaviva Digitaltec.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>