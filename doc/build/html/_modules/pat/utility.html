
<!DOCTYPE html>

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pat.utility &#8212; PAT 0.1.0 documentazione</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    
    <link rel="index" title="Indice" href="../../genindex.html" />
    <link rel="search" title="Cerca" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigazione</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Indice generale"
             accesskey="I">indice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Indice del modulo Python"
             >moduli</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PAT 0.1.0 documentazione</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Codice del modulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pat.utility</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Codice sorgente per pat.utility</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: iso-8859-15 -*-</span>

<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">memory_profiler</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">dateparser</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">from</span> <span class="nn">logging.config</span> <span class="kn">import</span> <span class="n">dictConfig</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1"># SPARK</span>

<span class="kn">from</span> <span class="nn">pat</span> <span class="kn">import</span> <span class="n">env</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span><span class="p">,</span> <span class="n">SparkContext</span>
    <span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">HiveContext</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">SQLContext</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># KAFKA</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaConsumer</span>
    <span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaClient</span>
    <span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># per usare la classe fare i seguenti import:</span>
<span class="c1"># from utility import Common</span>
<span class="c1"># from utility import Logger</span>
<span class="c1"># from utility import Spark</span>
<span class="c1"># from utility import Hdfs</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">v 2.2</span>
<span class="sd">- aggiunta hdfs_merge_files</span>
<span class="sd">- modifica copyLogHdfs</span>
<span class="sd">- aggiunta classe logger</span>
<span class="sd">- aggiunto in common.initializeVar() parametro per sezione e gestione schema dataframe (StructType) #GV</span>
<span class="sd">- modifica executeMany nella classe CxOracle</span>
<span class="sd">- aggiunto timoeut request</span>

<span class="sd">v 2.3 Antonino</span>
<span class="sd">- aggiunta set_key_value() in DbCxOracle</span>
<span class="sd">- aggiunta get_key_value() in DbCxOracle</span>
<span class="sd">- aggiunta campo &#39;info&#39; in class ErrorException</span>
<span class="sd">- modifica request in class Http -&gt; raise ErrorException(..., info=response)</span>
<span class="sd">- aggiuna func warning() in Logger</span>

<span class="sd">v 2.3.1 Giuseppe</span>
<span class="sd">- aggiunta &quot;encoding=&quot;UTF-8&quot;, nencoding=&quot;UTF-8&quot;&quot; in connect in DbCxOracle</span>

<span class="sd">v 2.3.2 Antonino</span>
<span class="sd">- aggiunta getNumExecution() in Common</span>
<span class="sd">- aggiunta roundDate() in Common</span>
<span class="sd">- aggiunta parametro &quot;parameters&quot; in executeProcedure() di DBoracle</span>
<span class="sd">- aggiunta union_date_intervals() in Common</span>

<span class="sd">v 2.3.3 Michele</span>
<span class="sd">- modifica funzione getDfFromQuery da Oracle</span>

<span class="sd">v 2.3.4 Giuseppe Iossa</span>
<span class="sd">- aggiunta della classe FieldControl</span>
<span class="sd">- aggiunta della classe Adl</span>

<span class="sd">v 2.3.5 Antonino</span>
<span class="sd">- aggiunta classe Compattatore</span>

<span class="sd">v 2.3.6 Michele</span>
<span class="sd">- aggiunta hdfsMv nella classe Hdfs</span>

<span class="sd">v 2.3.7 Antonino</span>
<span class="sd">- aggiunta classe Compattatore (nuova versione)</span>

<span class="sd">v 2.3.8 Giuseppe</span>
<span class="sd">- modifica logEndExecution (scrittura in nuova tabella log_hdfs)</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="encryptStr"><a class="viewcode-back" href="../../pat.html#pat.utility.encryptStr">[documenti]</a><span class="k">def</span> <span class="nf">encryptStr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="PatValidationError"><a class="viewcode-back" href="../../pat.html#pat.utility.PatValidationError">[documenti]</a><span class="k">class</span> <span class="nc">PatValidationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="Logger"><a class="viewcode-back" href="../../pat.html#pat.utility.Logger">[documenti]</a><span class="k">class</span> <span class="nc">Logger</span><span class="p">:</span>
<div class="viewcode-block" id="Logger.init"><a class="viewcode-back" href="../../pat.html#pat.utility.Logger.init">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">time_precision</span><span class="o">=</span><span class="s2">&quot;second&quot;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;INFO&quot;</span><span class="p">):</span>
        <span class="c1"># local_log_filename = &quot;/tmp/&quot; + id + &quot;.log&quot;</span>
        <span class="c1"># local_log_filename = &quot;c:/temp/&quot; + id + &quot;.log&quot;</span>
        <span class="n">local_log_filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_log_path</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">LOGGING_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># root logger</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="n">log_level</span><span class="p">,</span>
                    <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;file_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;console_handler&#39;</span><span class="p">],</span>
                <span class="p">},</span>
                <span class="s1">&#39;my.package&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;propagate&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;file_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;console_handler&#39;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;console_handler&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;formatter&#39;</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;logging.StreamHandler&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;stream&#39;</span><span class="p">:</span> <span class="s1">&#39;ext://sys.stdout&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;http_handler&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;formatter&#39;</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;logging.handlers.HTTPHandler&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;127.0.0.1:3000&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;/log&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s1">&#39;file_handler&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;logging.handlers.RotatingFileHandler&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;NOTSET&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;formatter&#39;</span><span class="p">:</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">local_log_filename</span><span class="p">,</span>
                    <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;maxBytes&#39;</span><span class="p">:</span> <span class="mi">10485760</span><span class="p">,</span>
                    <span class="s1">&#39;backupCount&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="s1">&#39;formatters&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;info&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">|</span><span class="si">%(levelname)s</span><span class="s1">|</span><span class="si">%(name)s</span><span class="s1">::</span><span class="si">%(module)s</span><span class="s1">|</span><span class="si">%(message)s</span><span class="s1">&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">LOGGING_CONFIG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dictConfig</span><span class="p">(</span><span class="n">LOGGING_CONFIG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;py4j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pyspark&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Spark"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark">[documenti]</a><span class="k">class</span> <span class="nc">Spark</span><span class="p">:</span>
    <span class="n">spark</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sparkContext</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hiveContext</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">APP_NAME</span><span class="p">,</span> <span class="n">configDict</span><span class="p">):</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">setAppName</span><span class="p">(</span><span class="n">APP_NAME</span><span class="p">)</span>
        <span class="n">spark_cfg</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="n">APP_NAME</span><span class="p">)</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">configDict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">configDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">spark_cfg</span> <span class="o">=</span> <span class="n">spark_cfg</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spark</span> <span class="o">=</span> <span class="n">spark_cfg</span><span class="o">.</span><span class="n">enableHiveSupport</span><span class="p">()</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
        <span class="c1"># self.spark = spark_cfg.getOrCreate()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">setLogLevel</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Spark.get_spark"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_spark">[documenti]</a>    <span class="k">def</span> <span class="nf">get_spark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span></div>

<div class="viewcode-block" id="Spark.get_spark_context"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_spark_context">[documenti]</a>    <span class="k">def</span> <span class="nf">get_spark_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span></div>

<div class="viewcode-block" id="Spark.get_application_id"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_application_id">[documenti]</a>    <span class="k">def</span> <span class="nf">get_application_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">applicationId</span></div>

<div class="viewcode-block" id="Spark.get_sql_context"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_sql_context">[documenti]</a>    <span class="k">def</span> <span class="nf">get_sql_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SQLContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spark.get_hive_context"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_hive_context">[documenti]</a>    <span class="k">def</span> <span class="nf">get_hive_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiveContext</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HiveContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hiveContext</span></div>

<div class="viewcode-block" id="Spark.close"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.close">[documenti]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

    <span class="c1"># def __del__(self):</span>
    <span class="c1">#    self.sparkContext.stop()</span>

<div class="viewcode-block" id="Spark.add_df_hash_key"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.add_df_hash_key">[documenti]</a>    <span class="k">def</span> <span class="nf">add_df_hash_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">hive_key_list</span><span class="p">):</span>
        <span class="n">getattr_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hive_key_list</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
            <span class="s2">&quot;key&quot;</span><span class="p">,</span>
            <span class="n">sha2</span><span class="p">(</span>
                <span class="n">concat_ws</span><span class="p">(</span>
                    <span class="s2">&quot;||&quot;</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">getattr_list</span>
                    <span class="c1"># getattr(df,*data)</span>

                <span class="p">),</span>
                <span class="mi">256</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Spark.get_df_from_csv"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_df_from_csv">[documenti]</a>    <span class="k">def</span> <span class="nf">get_df_from_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># .option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;) \</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

    <span class="c1"># Modifica Michele</span>
<div class="viewcode-block" id="Spark.get_df_from_query"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_df_from_query">[documenti]</a>    <span class="k">def</span> <span class="nf">get_df_from_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">oracle_param</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">           oracle_param di esempio </span>
<span class="sd">           oracle_param={&quot;url&quot;:&quot;127.0.0.1:1521&quot;, &quot;user&quot;:&quot;utente_login&quot;, &quot;password&quot;:&quot;utente_password&quot;}</span>
<span class="sd">           per oracle query puo&#39; essere o la tabella o la query con l&#39;alias finale esempio:</span>
<span class="sd">                 (select * from te_viaggi where ROWNUM &lt;2) te_viaggi</span>
<span class="sd">            e senza campi geometrici nella select </span>
<span class="sd">            oracle.jdbc.driver.OracleDriver</span>
<span class="sd">            .option(&quot;driver&quot;, &quot;oracle.jdbc.driver.OracleDriver&quot;) \&#39;</span>
<span class="sd">            .option(&quot;driver&quot;, &quot;org.postgresql.Driver&quot;) \&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">oracle_param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">oracle_param</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">read</span> \
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;jdbc&quot;</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">oracle_param</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;dbtable&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">oracle_param</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="n">oracle_param</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># return self.getHiveContext().sql( query )</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spark_context</span><span class="p">()</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></div>

<div class="viewcode-block" id="Spark.get_df_lower_column"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_df_lower_column">[documenti]</a>    <span class="k">def</span> <span class="nf">get_df_lower_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># return  (df.withColumnRenamed(c, c.lower()) for c in df.columns)</span>
        <span class="n">df_lower</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_lower</span></div>

<div class="viewcode-block" id="Spark.get_df_upper_column"><a class="viewcode-back" href="../../pat.html#pat.utility.Spark.get_df_upper_column">[documenti]</a>    <span class="k">def</span> <span class="nf">get_df_upper_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span>
        <span class="c1"># return  (df.withColumnRenamed(c, c.lower()) for c in df.columns)</span>
        <span class="n">df_upper</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df_upper</span></div></div>


<div class="viewcode-block" id="Kafka"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka">[documenti]</a><span class="k">class</span> <span class="nc">Kafka</span><span class="p">():</span>
    <span class="n">CONSUMER_INSTANCE_NOT_FOUND</span> <span class="o">=</span> <span class="mi">40403</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topicName</span><span class="p">,</span> <span class="n">consumerName</span><span class="p">,</span> <span class="n">consumerInstance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span> <span class="o">=</span> <span class="n">consumerName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span> <span class="o">=</span> <span class="n">consumerInstance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topicName</span> <span class="o">=</span> <span class="n">topicName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.kafka.json.v2+json&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/vnd.kafka.json.v2+json&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initParam</span><span class="p">()</span>

<div class="viewcode-block" id="Kafka.initParam"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka.initParam">[documenti]</a>    <span class="k">def</span> <span class="nf">initParam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;anasDSS12345!&quot;</span></div>

<div class="viewcode-block" id="Kafka.createConsumer"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka.createConsumer">[documenti]</a>    <span class="k">def</span> <span class="nf">createConsumer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">consumer_creation</span> <span class="o">=</span> <span class="s2">&quot;https://130.162.113.13:1080/restproxy/consumers/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;auto.offset.reset&quot;</span><span class="p">:</span> <span class="s2">&quot;earliest&quot;</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">consumer_creation</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
        <span class="n">resp_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">):</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="s2">&quot;/consumers/(.*?)/&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">resp_dict</span><span class="p">[</span><span class="s2">&quot;base_uri&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp_dict</span><span class="p">[</span><span class="s2">&quot;instance_id&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span></div>

<div class="viewcode-block" id="Kafka.subscribe"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka.subscribe">[documenti]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">consumer_subscription</span> <span class="o">=</span> <span class="s2">&quot;https://130.162.113.13:1080/restproxy/consumers/</span><span class="si">{}</span><span class="s2">/instances/</span><span class="si">{}</span><span class="s2">/subscription&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;topics&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">topicName</span><span class="p">]}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - subscribe - consumer_subscription == &quot;</span> <span class="o">+</span> <span class="n">consumer_subscription</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - subscribe - self.topicName == &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">topicName</span><span class="p">)</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">consumer_subscription</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - subscribe - resp.status_code = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">299</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - subscribe - subscribe error&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Kafka.deleteConsumer"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka.deleteConsumer">[documenti]</a>    <span class="k">def</span> <span class="nf">deleteConsumer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">consumer_delete</span> <span class="o">=</span> <span class="s2">&quot;https://130.162.113.13:1080//restproxy/consumers/</span><span class="si">{}</span><span class="s2">/instances/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;consumerInstanceId&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">consumer_delete</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deleteConsumer Error&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Kafka.readTopic"><a class="viewcode-back" href="../../pat.html#pat.utility.Kafka.readTopic">[documenti]</a>    <span class="k">def</span> <span class="nf">readTopic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - init&quot;</span><span class="p">)</span>
        <span class="n">topic_url</span> <span class="o">=</span> <span class="s2">&quot;https://130.162.113.13:1080/restproxy/consumers/</span><span class="si">{}</span><span class="s2">/instances/</span><span class="si">{}</span><span class="s2">/records/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">consumerInstance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumerName</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - topic_url = &quot;</span> <span class="o">+</span> <span class="n">topic_url</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">topic_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - resp.status_code = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - Consumer instance not found.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONSUMER_INSTANCE_NOT_FOUND</span><span class="p">)</span>
            <span class="c1"># raise Exception(&quot;CONSUMER_INSTANCE_NOT_FOUND&quot;)</span>
            <span class="c1"># Common.raiseException(None, None, self.CONSUMER_INSTANCE_NOT_FOUND)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">406</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Kafka - readTopic - Consumer format does not match the embedded format requested by the Accept header.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Consumer format does not match the embedded format requested by the Accept header.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">500</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - Error 500&quot;</span><span class="p">)</span>
            <span class="n">data_error</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Kafka - readTopic - Consumer problem in read Topics.&quot;</span> <span class="o">+</span> <span class="n">data_error</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteConsumer</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Consumer problem in read Topics.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Json"><a class="viewcode-back" href="../../pat.html#pat.utility.Json">[documenti]</a><span class="k">class</span> <span class="nc">Json</span><span class="p">:</span>
<div class="viewcode-block" id="Json.loads"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.loads">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="o">*</span><span class="n">json_array</span><span class="p">):</span>
        <span class="n">json_union</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">json_in</span> <span class="ow">in</span> <span class="n">json_array</span><span class="p">:</span>
            <span class="n">json_tmp</span> <span class="o">=</span> <span class="n">json_in</span>

            <span class="c1"># cerco tutti i text contenuti in ${text}</span>
            <span class="n">to_replace</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\${(.*?)\}&quot;</span><span class="p">,</span> <span class="n">json_tmp</span><span class="p">)</span>

            <span class="n">json_tmp_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_union</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">json_tmp_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_union</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_replace</span><span class="p">:</span>
                <span class="n">nested_val</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">json_tmp_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">nested_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="s2">&quot; not found in json&quot;</span><span class="p">)</span>

                <span class="n">nested_val_str</span> <span class="o">=</span> <span class="n">nested_val</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nested_val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">nested_val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">nested_val</span><span class="p">)</span>
                    <span class="n">json_tmp</span> <span class="o">=</span> <span class="n">json_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">${&quot;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nested_val</span><span class="p">))</span>  <span class="c1"># elimino gli apici</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nested_val</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>  <span class="c1"># aggiungo gli apici per la stringa</span>
                        <span class="n">json_tmp</span> <span class="o">=</span> <span class="n">json_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">${&quot;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nested_val</span><span class="p">))</span>  <span class="c1"># elimino gli apici</span>
                    <span class="n">json_tmp</span> <span class="o">=</span> <span class="n">json_tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;${&quot;</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nested_val</span><span class="p">))</span>

                <span class="n">json_tmp_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_tmp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_union</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">json_union</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_tmp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">json_union</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_tmp</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;json_union == </span><span class="si">{</span><span class="n">json_union</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">json_union</span></div>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Metodo Sostituzione Variabili con jinja2</span>
<div class="viewcode-block" id="Json.loadsWithTemplate"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.loadsWithTemplate">[documenti]</a>        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">loadsWithTemplate</span><span class="p">(</span><span class="n">json_file</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">jinja2</span> <span class="k">as</span> <span class="nn">j2</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">j2</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span>
                <span class="n">loader</span><span class="o">=</span><span class="n">j2</span><span class="o">.</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">searchpath</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">json_dict</span><span class="p">,</span> <span class="s2">&quot;env&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">j2</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">vars</span><span class="p">))</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
            <span class="p">)</span></div>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No jinja2 installed&quot;</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="c1"># metodo per il controllo se la stringa  un json valido (is_json)</span>
<div class="viewcode-block" id="Json.is_json"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.is_json">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_json</span><span class="p">(</span><span class="n">my_json</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">my_json</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="c1"># ritorna None se key non esiste, altrimenti restituisce il valore</span>
<div class="viewcode-block" id="Json.get_value"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.get_value">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defval</span></div>

<div class="viewcode-block" id="Json.get_value_eval"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.get_value_eval">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_value_eval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">defval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defval</span></div>

    <span class="c1"># ritorna true se la chiave  presente almeno una volta nel json (per json innestati)</span>
<div class="viewcode-block" id="Json.check_key"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.check_key">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_key</span><span class="p">(</span><span class="n">json</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">json</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Json</span><span class="o">.</span><span class="n">check_key</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">list_item</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">list_item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">Json</span><span class="o">.</span><span class="n">check_key</span><span class="p">(</span><span class="n">list_item</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Json.merge"><a class="viewcode-back" href="../../pat.html#pat.utility.Json.merge">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; merge ricorsivo di due dict, sovrascrive i valori in &#39;conflitto&#39; &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict2</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dict2</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict1</span><span class="p">:</span>
                <span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Json</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">dict2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dict1</span></div></div>


<div class="viewcode-block" id="Common"><a class="viewcode-back" href="../../pat.html#pat.utility.Common">[documenti]</a><span class="k">class</span> <span class="nc">Common</span><span class="p">:</span>

<div class="viewcode-block" id="Common.validateFile"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.validateFile">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validateFile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Type non specificato&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span>
        <span class="kn">import</span> <span class="nn">xmlschema</span>
        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">):</span>
                <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;json_file&quot;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_schema</span><span class="p">:</span>
                            <span class="n">validate_schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">validate_schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
                    <span class="kn">import</span> <span class="nn">ast</span>
                    <span class="c1">#dict_str = data.decode(&quot;UTF-8&quot;)  # binary to str</span>
                    <span class="c1">#mydata = ast.literal_eval(dict_str)</span>
                    <span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">validate_schema</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;xml&quot;</span><span class="p">):</span>  <span class="c1"># solo fileValidate</span>
                <span class="n">data_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="n">tree</span><span class="o">=</span><span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">data_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
                    <span class="n">xsd</span> <span class="o">=</span> <span class="n">xmlschema</span><span class="o">.</span><span class="n">XMLSchema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
                    <span class="n">xsd</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">data_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="Common.round_date"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.round_date">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">round_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">minutes_to_round</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="c1"># Funzione per l&#39;arrotondamento dei minuti di una data</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">minutes_to_round</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">roud_min</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">minute</span> <span class="o">-</span> <span class="n">date</span><span class="o">.</span><span class="n">minute</span> <span class="o">%</span> <span class="mi">10</span>
            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="n">roud_min</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">minutes_to_round</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">roud_min</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">minute</span> <span class="o">-</span> <span class="n">date</span><span class="o">.</span><span class="n">minute</span> <span class="o">%</span> <span class="mi">5</span>
            <span class="k">return</span> <span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="n">roud_min</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="c1"># Se obj non e&#39; di tipo list ritorna un array di 1 elemento che include obj</span>
<div class="viewcode-block" id="Common.to_list"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.to_list">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iterate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">ret_list</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ret_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ret_list</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">iterate</span><span class="p">:</span>
            <span class="n">ret_list_2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ret_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">ret_list_2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret_list_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret_list_2</span>
        <span class="k">return</span> <span class="n">ret_list</span></div>

<div class="viewcode-block" id="Common.replace_time"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.replace_time">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">replace_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">value</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">year</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%m&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">month</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">day</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%H&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">hour</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%M&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">minute</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%S&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{:02d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">second</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">microsecond</span><span class="p">))</span></div>

<div class="viewcode-block" id="Common.get_protocol"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.get_protocol">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_protocol</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    restituisce il nome del file contenuto nell&#39;url</span>
<span class="sd">    input : url=&quot;webhdfs://10.206.227.251:9870/ingestion/json_example/pic_treni_out_tmp/2022/02/10/file_name.xxx&quot;</span>
<span class="sd">    example_1 = level=None, folder=None # return file_name.xxx</span>
<span class="sd">    example_2 = level=3, folder=None # return 2022/02/10/file_name.xxx</span>
<span class="sd">    example_3 = level=None, folder=json_example # return pic_treni_out_tmp/2022/02/10/file_name.xxx</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Common.get_filename_from_url"><a class="viewcode-back" href="../../pat.html#pat.utility.Common.get_filename_from_url">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_filename_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">folder</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">level_</span> <span class="o">=</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">Common</span><span class="o">.</span><span class="n">get_filename_from_url</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level_</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">filename</span></div></div>


<span class="c1">#### DECORATORS ####</span>
<div class="viewcode-block" id="TimingAndProfile"><a class="viewcode-back" href="../../pat.html#pat.utility.TimingAndProfile">[documenti]</a><span class="k">class</span> <span class="nc">TimingAndProfile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ingestion&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enable_profile</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_profile</span> <span class="o">=</span> <span class="n">enable_profile</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">memory_profiler</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_profile</span><span class="p">:</span>
                <span class="n">to_return</span> <span class="o">=</span> <span class="n">memory_profiler</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="n">func</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_return</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">t2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="n">memory_profiler</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span>

            <span class="c1"># self.logger = logging.getLogger( &quot;ingestion&quot; )</span>
            <span class="c1"># self.logger = Logger.mylogger</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG - TimingAndProfile -- [</span><span class="si">{}</span><span class="s2">] - Execution Time: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                                                                             <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEBUG - TimingAndProfile -- [</span><span class="si">{}</span><span class="s2">] - Memory Usage: </span><span class="si">{}</span><span class="s2"> MiB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TimingAndProfile - [</span><span class="si">{}</span><span class="s2">] - Execution Time: </span><span class="si">{}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span>
                        <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;TimingAndProfile - [</span><span class="si">{}</span><span class="s2">] -Memory Usage: </span><span class="si">{}</span><span class="s2"> MiB&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">m1</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="k">return</span> <span class="n">to_return</span>

        <span class="k">return</span> <span class="n">wrapper</span></div>


<span class="c1">##############################################################################################</span>
<span class="c1">############################     GESTIONE ECCEZIONI INIT     #################################</span>
<span class="c1">#############################################################################################</span>

<div class="viewcode-block" id="FieldControl"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl">[documenti]</a><span class="k">class</span> <span class="nc">FieldControl</span><span class="p">:</span>
<div class="viewcode-block" id="FieldControl.checkRequired"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl.checkRequired">[documenti]</a>    <span class="k">def</span> <span class="nf">checkRequired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;The field </span><span class="si">{}</span><span class="s2"> cannot be null</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldControl.checkDate"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl.checkDate">[documenti]</a>    <span class="k">def</span> <span class="nf">checkDate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;yyyy-MM-dd HH24:mi:ss&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkRequired</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">dateparser</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="n">fuzzy</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;The field </span><span class="si">{}</span><span class="s2"> is not a date string&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="FieldControl.checkString"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl.checkString">[documenti]</a>    <span class="k">def</span> <span class="nf">checkString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkRequired</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Required type for field </span><span class="si">{}</span><span class="s2"> is String&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="FieldControl.checkNumber"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl.checkNumber">[documenti]</a>    <span class="k">def</span> <span class="nf">checkNumber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">fuzzy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkRequired</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Required type for field </span><span class="si">{}</span><span class="s2"> is a number of any type&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

<div class="viewcode-block" id="FieldControl.checkValuesInList"><a class="viewcode-back" href="../../pat.html#pat.utility.FieldControl.checkValuesInList">[documenti]</a>    <span class="k">def</span> <span class="nf">checkValuesInList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">valueList</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">required</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkRequired</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">valueList</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;Field </span><span class="si">{}</span><span class="s2"> can only contain a value between </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">valueList</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">   def checkValuesInList(self, value, field_name, valueList, required = False):</span>
<span class="sd">       try:</span>
<span class="sd">           if (required and value is None):</span>
<span class="sd">               self.checkRequired(value, field_name)</span>
<span class="sd">           elif (required and value is not None):</span>
<span class="sd">               if (value in valueList):</span>
<span class="sd">                   return value</span>
<span class="sd">               else:</span>
<span class="sd">                   error_message = &quot;Field {} can only contain a value between [{}]&quot;.format(field_name, valueList)</span>
<span class="sd">                   raise ErrorException(exception=None, code=ErrorException.GENERIC_ERROR, info=error_message)</span>
<span class="sd">           elif (value is None):</span>
<span class="sd">               return None</span>
<span class="sd">           elif (value in valueList):</span>
<span class="sd">               return value</span>
<span class="sd">           else:</span>
<span class="sd">               error_message = &quot;Field {} can only contain a value between [{}]&quot;.format(field_name, valueList)</span>
<span class="sd">               raise ErrorException(exception = None, code = ErrorException.GENERIC_ERROR, info = error_message)</span>
<span class="sd">       except Exception as err:</span>
<span class="sd">           raise err</span>

<span class="sd">   def checkString(self, value, field_name, required = False):</span>
<span class="sd">       try:</span>
<span class="sd">           if (required and value is None):</span>
<span class="sd">               self.checkRequired(value, field_name)</span>
<span class="sd">           elif (required and value is not None):</span>
<span class="sd">               if isinstance(value, str):</span>
<span class="sd">                   return value</span>
<span class="sd">               else:</span>
<span class="sd">                   error_message = &quot;Required type for field {} is String&quot;.format(field_name)</span>
<span class="sd">                   raise ErrorException(exception=None, code=ErrorException.GENERIC_ERROR, info=error_message)</span>
<span class="sd">           elif (value is None):</span>
<span class="sd">               return None</span>
<span class="sd">           if isinstance(value, str):</span>
<span class="sd">               return value</span>
<span class="sd">           else:</span>
<span class="sd">               error_message = &quot;Required type for field {} is String&quot;.format(field_name)</span>
<span class="sd">               raise ErrorException(exception = None, code = ErrorException.GENERIC_ERROR, info = error_message)</span>
<span class="sd">       except Exception as err:</span>
<span class="sd">           raise err</span>

<span class="sd">   def checkNumber(self, value, field_name, required = False):</span>
<span class="sd">       try:</span>
<span class="sd">           if (required and value is None):</span>
<span class="sd">               self.checkRequired(value, field_name)</span>
<span class="sd">           elif(required and value is not None):</span>
<span class="sd">               if (isinstance(value, float) or isinstance(value, int) or isinstance(value, complex)):</span>
<span class="sd">                   return value</span>
<span class="sd">               else:</span>
<span class="sd">                   error_message = &quot;Required type for field {} is a number of any type&quot;.format(field_name)</span>
<span class="sd">                   raise ErrorException(exception=None, code=ErrorException.GENERIC_ERROR, info=error_message)</span>
<span class="sd">           elif (value is None):</span>
<span class="sd">               return None</span>
<span class="sd">           elif (isinstance(value, float) or isinstance(value, int) or isinstance(value, complex)):</span>
<span class="sd">               return value</span>
<span class="sd">           else:</span>
<span class="sd">               error_message = &quot;Required type for field {} is a number of any type&quot;.format(field_name)</span>
<span class="sd">               raise ErrorException(exception = None, code = ErrorException.GENERIC_ERROR, info = error_message)</span>
<span class="sd">       except Exception as err:</span>
<span class="sd">           raise err</span>
<span class="sd">   &#39;&#39;&#39;</span></div>


<span class="c1">##############################################################################################</span>
<span class="c1">############################         AGGIUNTO NUOVO          #################################</span>
<span class="c1">##############################################################################################</span>


<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">mydict = {&#39;user&#39;: &#39;Bot&#39;, &#39;version&#39;: 0.15, &#39;items&#39;: 43, &#39;methods&#39;: &#39;standard&#39;, &#39;time&#39;: 1536304833437, &#39;logs&#39;: &#39;no&#39;, &#39;status&#39;: &#39;completed&#39;}</span>
<span class="sd">columns = &#39;, &#39;.join(&quot;`&quot; + str(x).replace(&#39;/&#39;, &#39;_&#39;) + &quot;`&quot; for x in mydict.keys())</span>
<span class="sd">values = &#39;, &#39;.join(&quot;&#39;&quot; + str(x).replace(&#39;/&#39;, &#39;_&#39;) + &quot;&#39;&quot; for x in mydict.values())</span>
<span class="sd">sql = &quot;INSERT INTO %s ( %s ) VALUES ( %s );&quot; % (&#39;mytable&#39;, columns, values)</span>
<span class="sd">print(sql)</span>

<span class="sd">https://webpy.org/cookbook/where_dict</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="SqlBuilder"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder">[documenti]</a><span class="k">class</span> <span class="nc">SqlBuilder</span><span class="p">:</span>
<div class="viewcode-block" id="SqlBuilder.to_timestamp"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_timestamp">[documenti]</a>    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">dt_</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;to_timestamp(&#39;</span><span class="si">{</span><span class="n">dt_</span><span class="si">}</span><span class="s2">&#39;, &#39;yyyy-MM-dd HH24:mi:ss&#39;)&quot;</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    def to_insert_(self, table, columns, tuples):</span>
<span class="sd">        fields = &#39;,&#39;.join(map(str, columns))</span>
<span class="sd">        question = &#39;,&#39;.join([&#39;?&#39;] * len(columns))</span>
<span class="sd">        query = f&quot;insert into {table} ({fields}) values ({question})&quot;</span>
<span class="sd">        queries = []</span>

<span class="sd">        for t in tuples:</span>
<span class="sd">            for v in t:</span>
<span class="sd">                v = self.to_value(v)</span>
<span class="sd">        return queries, tuples</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="SqlBuilder.getInsertString"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.getInsertString">[documenti]</a>    <span class="k">def</span> <span class="nf">getInsertString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="n">question</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;insert into </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">) values (</span><span class="si">{</span><span class="n">question</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="SqlBuilder.to_insert"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_insert">[documenti]</a>    <span class="k">def</span> <span class="nf">to_insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">tuples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getInsertString</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tuples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">query</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                <span class="n">queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">queries</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="SqlBuilder.to_update"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_update">[documenti]</a>    <span class="k">def</span> <span class="nf">to_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">tuples</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_null</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        for t in tuples:</span>
<span class="sd">            update_set = []</span>
<span class="sd">            update_where = [&quot;1 = 1&quot;]</span>
<span class="sd">            </span>
<span class="sd">            for index in range(len(t)):</span>
<span class="sd">                if columns[index] in where:</span>
<span class="sd">                    update_where.append(self.to_value2(columns[index], t[index]))</span>
<span class="sd">                elif t[index] is not None or ignore_null:</span>
<span class="sd">                    update_set.append(self.to_value2(columns[index], t[index]))</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            for index in range(len(t)):</span>
<span class="sd">                if t[index] is not None or ignore_null: #&lt;---?</span>
<span class="sd">                    update_set.append(self.to_value2(columns[index], t[index]))</span>
<span class="sd">            if where:</span>
<span class="sd">                for (key, value) in where.items():</span>
<span class="sd">                    if value is not None or ignore_null:</span>
<span class="sd">                        update_where.append(self.to_value2(key, value))</span>
<span class="sd">  </span>
<span class="sd">            upd = &quot;,&quot;.join(update_set)</span>
<span class="sd">            whr = &quot; and &quot;.join(update_where)</span>
<span class="sd">            query = f&quot;update {table} set {upd} where {whr}&quot;</span>
<span class="sd">            print(query)</span>
<span class="sd">            queries.append(query)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">update_where</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1=1&quot;</span><span class="p">]</span>
        <span class="n">upd</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> = ?&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">where</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ignore_null</span><span class="p">:</span>
                    <span class="n">update_where</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_value2</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">whr</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">update_where</span><span class="p">)</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;update </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> set </span><span class="si">{</span><span class="n">upd</span><span class="si">}</span><span class="s2"> where </span><span class="si">{</span><span class="n">whr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">queries</span></div>

<div class="viewcode-block" id="SqlBuilder.to_select"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_select">[documenti]</a>    <span class="k">def</span> <span class="nf">to_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_null</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">))</span>
        <span class="n">select_where</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1=1&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">where</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ignore_null</span><span class="p">:</span>
                    <span class="n">select_where</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_value2</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">whr</span> <span class="o">=</span> <span class="s2">&quot; and &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_where</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;select </span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2"> where </span><span class="si">{</span><span class="n">whr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span></div>

<div class="viewcode-block" id="SqlBuilder.to_value2"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_value2">[documenti]</a>    <span class="k">def</span> <span class="nf">to_value2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">is_where</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_where</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=null&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> is null&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;&quot;</span></div>

<div class="viewcode-block" id="SqlBuilder.to_value"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_value">[documenti]</a>    <span class="k">def</span> <span class="nf">to_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;null&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;&quot;</span></div>

<div class="viewcode-block" id="SqlBuilder.to_value_"><a class="viewcode-back" href="../../pat.html#pat.utility.SqlBuilder.to_value_">[documenti]</a>    <span class="k">def</span> <span class="nf">to_value_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">v</span></div></div>


<div class="viewcode-block" id="ImpalaSqlBuilder"><a class="viewcode-back" href="../../pat.html#pat.utility.ImpalaSqlBuilder">[documenti]</a><span class="k">class</span> <span class="nc">ImpalaSqlBuilder</span><span class="p">(</span><span class="n">SqlBuilder</span><span class="p">):</span>
<div class="viewcode-block" id="ImpalaSqlBuilder.to_timestamp"><a class="viewcode-back" href="../../pat.html#pat.utility.ImpalaSqlBuilder.to_timestamp">[documenti]</a>    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">dt_</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/%m/%Y %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;to_timestamp(&#39;</span><span class="si">{</span><span class="n">dt_</span><span class="si">}</span><span class="s2">&#39;, &#39;dd/MM/yyyy HH:mm:ss&#39;)&quot;</span></div></div>


<div class="viewcode-block" id="PostgresSqlBuilder"><a class="viewcode-back" href="../../pat.html#pat.utility.PostgresSqlBuilder">[documenti]</a><span class="k">class</span> <span class="nc">PostgresSqlBuilder</span><span class="p">(</span><span class="n">SqlBuilder</span><span class="p">):</span>
<div class="viewcode-block" id="PostgresSqlBuilder.to_timestamp"><a class="viewcode-back" href="../../pat.html#pat.utility.PostgresSqlBuilder.to_timestamp">[documenti]</a>    <span class="k">def</span> <span class="nf">to_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="n">dt_</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;to_timestamp(&#39;</span><span class="si">{</span><span class="n">dt_</span><span class="si">}</span><span class="s2">&#39;, &#39;yyyy-MM-dd HH24:mi:ss&#39;)&quot;</span></div></div>


<span class="c1">##############################################################################################</span>
<span class="c1">############################     GESTIONE ECCEZIONI END      #################################</span>
<span class="c1">##############################################################################################</span>

<span class="c1"># gestione eccezione non gestita</span>
<span class="n">old_exception</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>


<div class="viewcode-block" id="handle_exception"><a class="viewcode-back" href="../../pat.html#pat.utility.handle_exception">[documenti]</a><span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">__excepthook__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">hdfs_date_format</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># local_log_filename = &quot;/tmp/handle_exception.log&quot;</span>

    <span class="c1"># local_log_filename = &quot;c:/temp/handle_exception.log&quot;</span>

    <span class="n">local_log_filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_log_handle_exception</span><span class="p">()</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="se">\t</span><span class="s1">- </span><span class="si">%(name)s</span><span class="se">\t</span><span class="s1">- </span><span class="si">%(levelname)s</span><span class="se">\t</span><span class="s1">- (</span><span class="si">%(threadName)-10s</span><span class="s1">)</span><span class="se">\t</span><span class="s1">- </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                                  <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">mylogger_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">local_log_filename</span><span class="p">)</span>
    <span class="n">mylogger_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">mylogger_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

    <span class="n">mylogger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ERROR&quot;</span><span class="p">)</span>
    <span class="n">mylogger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">mylogger_handler</span><span class="p">)</span>

    <span class="n">ENABLE_PRINT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ENABLE_PRINT&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ENABLE_PRINT</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ENABLE_PRINT = &#39;</span> <span class="o">+</span> <span class="n">ENABLE_PRINT</span><span class="p">)</span>

    <span class="n">mylogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Uncaught exception&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">))</span>
    <span class="n">mylogger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">mylogger_handler</span><span class="p">)</span>
    <span class="n">mylogger_handler</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">mylogger_handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">old_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">)</span></div>


<span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">handle_exception</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Ricerca veloce</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigazione</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Indice generale"
             >indice</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Indice del modulo Python"
             >moduli</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">PAT 0.1.0 documentazione</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Codice del modulo</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">pat.utility</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Giuseppe Ventura.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>