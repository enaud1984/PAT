
<!DOCTYPE html>

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>fsspec.spec &#8212; PAT 0.1.0 documentazione</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="index" title="Indice" href="../../genindex.html" />
    <link rel="search" title="Cerca" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Codice sorgente per fsspec.spec</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">errno</span> <span class="kn">import</span> <span class="n">ESPIPE</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">has_magic</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha256</span>

<span class="kn">from</span> <span class="nn">.callbacks</span> <span class="kn">import</span> <span class="n">_DEFAULT_CALLBACK</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">apply_config</span><span class="p">,</span> <span class="n">conf</span>
<span class="kn">from</span> <span class="nn">.dircache</span> <span class="kn">import</span> <span class="n">DirCache</span>
<span class="kn">from</span> <span class="nn">.transaction</span> <span class="kn">import</span> <span class="n">Transaction</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">_unstrip_protocol</span><span class="p">,</span> <span class="n">other_paths</span><span class="p">,</span> <span class="n">read_block</span><span class="p">,</span> <span class="n">stringify_path</span><span class="p">,</span> <span class="n">tokenize</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;fsspec&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Cached</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass for caching file system instances.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Instances are cached according to</span>

<span class="sd">    * The values of the class attributes listed in `_extra_tokenize_attributes`</span>
<span class="sd">    * The arguments passed to ``__init__``.</span>

<span class="sd">    This creates an additional reference to the filesystem, which prevents the</span>
<span class="sd">    filesystem from being garbage collected when all *user* references go away.</span>
<span class="sd">    A call to the :meth:`AbstractFileSystem.clear_instance_cache` must *also*</span>
<span class="sd">    be made for a filesystem instance to be garbage collected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Note: we intentionally create a reference here, to avoid garbage</span>
        <span class="c1"># collecting instances when all other references are gone. To really</span>
        <span class="c1"># delete a FileSystem, the cache must be cleared.</span>
        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weakref_instance_cache&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># debug option for analysing fork/spawn conditions</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">apply_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">extra_tokens</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_extra_tokenize_attributes</span>
        <span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_pid</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_tokens</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;skip_instance_cache&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_pid</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip</span> <span class="ow">and</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cachable</span> <span class="ow">and</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Setting _fs_token here causes some static linters to complain.</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_fs_token_</span> <span class="o">=</span> <span class="n">token</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">storage_args</span> <span class="o">=</span> <span class="n">args</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">storage_options</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">async_impl</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">.asyn</span> <span class="kn">import</span> <span class="n">mirror_sync_methods</span>

                <span class="n">mirror_sync_methods</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cachable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
            <span class="k">return</span> <span class="n">obj</span>


<div class="viewcode-block" id="AbstractFileSystem"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem">[documenti]</a><span class="k">class</span> <span class="nc">AbstractFileSystem</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">_Cached</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract super-class for pythonic file-systems</span>

<span class="sd">    Implementations are expected to be compatible with or, better, subclass</span>
<span class="sd">    from here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cachable</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># this class can be cached, instances reused</span>
    <span class="n">_cached</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">22</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;abstract&quot;</span>
    <span class="n">async_impl</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">root_marker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># For some FSs, may require leading &#39;/&#39; or other character</span>

    <span class="c1">#: Extra *class attributes* that should be considered when hashing.</span>
    <span class="n">_extra_tokenize_attributes</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">storage_options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and configure file-system instance</span>

<span class="sd">        Instances may be cachable, so if similar enough arguments are seen</span>
<span class="sd">        a new instance is not required. The token attribute exists to allow</span>
<span class="sd">        implementations to cache instances if they wish.</span>

<span class="sd">        A reasonable default should be provided if there are no arguments.</span>

<span class="sd">        Subclasses should call this method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_listings_cache, listings_expiry_time, max_paths:</span>
<span class="sd">            passed to ``DirCache``, if the implementation supports</span>
<span class="sd">            directory listing caching. Pass use_listings_cache=False</span>
<span class="sd">            to disable such caching.</span>
<span class="sd">        skip_instance_cache: bool</span>
<span class="sd">            If this is a cachable implementation, pass True here to force</span>
<span class="sd">            creating a new instance even if a matching instance exists, and prevent</span>
<span class="sd">            storing this instance.</span>
<span class="sd">        asynchronous: bool</span>
<span class="sd">        loop: asyncio-compatible IOLoop or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span><span class="p">:</span>
            <span class="c1"># reusing instance, don&#39;t change</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intrans</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated_caches_in_transaction</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dircache</span> <span class="o">=</span> <span class="n">DirCache</span><span class="p">(</span><span class="o">**</span><span class="n">storage_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">storage_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_docs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;add_docs is no longer supported.&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">storage_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;add_aliases&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;add_aliases has been removed.&quot;</span><span class="p">,</span> <span class="ne">FutureWarning</span><span class="p">)</span>
        <span class="c1"># This is set in _Cached</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fs_token_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_fs_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs_token_</span>

    <span class="k">def</span> <span class="nf">__dask_tokenize__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs_token</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fs_token</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fs_token</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_fs_token</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">make_instance</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_protocol</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn path from fully-qualified to file-system-specific</span>

<span class="sd">        May require FS-specific handling, e.g., for relative paths or links.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">stringify_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">protos</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">protocol</span><span class="p">,)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="bp">cls</span><span class="o">.</span><span class="n">protocol</span>
        <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">protos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;://&quot;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">protocol</span> <span class="o">+</span> <span class="s2">&quot;::&quot;</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="c1"># use of root_marker to make minimum required path, e.g., &quot;/&quot;</span>
        <span class="k">return</span> <span class="n">path</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">root_marker</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_kwargs_from_urls</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If kwargs can be encoded in the paths, extract them here</span>

<span class="sd">        This should happen before instantiation of the class; incoming paths</span>
<span class="sd">        then should be amended to strip the options in methods.</span>

<span class="sd">        Examples may look like an sftp path &quot;sftp://user@host:/my/path&quot;, where</span>
<span class="sd">        the user and host should become kwargs and later get stripped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># by default, nothing happens</span>
        <span class="k">return</span> <span class="p">{}</span>

<div class="viewcode-block" id="AbstractFileSystem.current"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.current">[documenti]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the most recently created FileSystem</span>

<span class="sd">        If no instance has been created, then create one with defaults</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A context within which files are committed together upon exit</span>

<span class="sd">        Requires the file class to implement `.commit()` and `.discard()`</span>
<span class="sd">        for the normal and exception cases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span>

<div class="viewcode-block" id="AbstractFileSystem.start_transaction"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.start_transaction">[documenti]</a>    <span class="k">def</span> <span class="nf">start_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Begin write transaction for deferring files, non-context version&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intrans</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span></div>

<div class="viewcode-block" id="AbstractFileSystem.end_transaction"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.end_transaction">[documenti]</a>    <span class="k">def</span> <span class="nf">end_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finish write transaction, non-context version&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The invalid cache must be cleared after the transcation is completed.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated_caches_in_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated_caches_in_transaction</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractFileSystem.invalidate_cache"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.invalidate_cache">[documenti]</a>    <span class="k">def</span> <span class="nf">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Discard any cached directory information</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: string or None</span>
<span class="sd">            If None, clear all listings cached else listings at or under given</span>
<span class="sd">            path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Not necessary to implement invalidation mechanism, may have no cache.</span>
        <span class="c1"># But if have, you should call this method of parent class from your</span>
        <span class="c1"># subclass to ensure expiring caches after transacations correctly.</span>
        <span class="c1"># See the implementation of FTPFileSystem in ftp.py</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intrans</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_invalidated_caches_in_transaction</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.mkdir"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.mkdir">[documenti]</a>    <span class="k">def</span> <span class="nf">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">create_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create directory entry at path</span>

<span class="sd">        For systems that don&#39;t have true directories, may create an for</span>
<span class="sd">        this instance only and not touch the real filesystem</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            location</span>
<span class="sd">        create_parents: bool</span>
<span class="sd">            if True, this is equivalent to ``makedirs``</span>
<span class="sd">        kwargs:</span>
<span class="sd">            may be permissions, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>  <span class="c1"># not necessary to implement, may not have directories</span></div>

<div class="viewcode-block" id="AbstractFileSystem.makedirs"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.makedirs">[documenti]</a>    <span class="k">def</span> <span class="nf">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Recursively make directories</span>

<span class="sd">        Creates directory at path and any intervening required directories.</span>
<span class="sd">        Raises exception if, for instance, the path already exists but is a</span>
<span class="sd">        file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            leaf directory name</span>
<span class="sd">        exist_ok: bool (False)</span>
<span class="sd">            If False, will error if the target already exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>  <span class="c1"># not necessary to implement, may not have directories</span></div>

<div class="viewcode-block" id="AbstractFileSystem.rmdir"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.rmdir">[documenti]</a>    <span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove a directory, if empty&quot;&quot;&quot;</span>
        <span class="k">pass</span>  <span class="c1"># not necessary to implement, may not have directories</span></div>

<div class="viewcode-block" id="AbstractFileSystem.ls"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.ls">[documenti]</a>    <span class="k">def</span> <span class="nf">ls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List objects at path.</span>

<span class="sd">        This should include subdirectories and files at that location. The</span>
<span class="sd">        difference between a file and a directory must be clear when details</span>
<span class="sd">        are requested.</span>

<span class="sd">        The specific keys, or perhaps a FileInfo class, or similar, is TBD,</span>
<span class="sd">        but must be consistent across implementations.</span>
<span class="sd">        Must include:</span>

<span class="sd">        - full path to the entry (without protocol)</span>
<span class="sd">        - size of the entry, in bytes. If the value cannot be determined, will</span>
<span class="sd">          be ``None``.</span>
<span class="sd">        - type of entry, &quot;file&quot;, &quot;directory&quot; or other</span>

<span class="sd">        Additional information</span>
<span class="sd">        may be present, aproriate to the file-system, e.g., generation,</span>
<span class="sd">        checksum, etc.</span>

<span class="sd">        May use refresh=True|False to allow use of self._ls_from_cache to</span>
<span class="sd">        check for a saved listing and avoid calling the backend. This would be</span>
<span class="sd">        common where listing may be expensive.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">        detail: bool</span>
<span class="sd">            if True, gives a list of dictionaries, where each is the same as</span>
<span class="sd">            the result of ``info(path)``. If False, gives a list of paths</span>
<span class="sd">            (str).</span>
<span class="sd">        kwargs: may have additional backend-specific options, such as version</span>
<span class="sd">            information</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List of strings if detail is False, or list of directory information</span>
<span class="sd">        dicts if detail is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="k">def</span> <span class="nf">_ls_from_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check cache for listing</span>

<span class="sd">        Returns listing, if found (may me empty list for a directly that exists</span>
<span class="sd">        but contains nothing), None if not in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dircache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dircache</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dircache</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">path</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;directory&quot;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># parent dir was listed but did not contain this file</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">files</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="AbstractFileSystem.walk"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.walk">[documenti]</a>    <span class="k">def</span> <span class="nf">walk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all files belows path</span>

<span class="sd">        List all files, recursing into subdirectories; output is iterator-style,</span>
<span class="sd">        like ``os.walk()``. For a simple list of files, ``find()`` is available.</span>

<span class="sd">        Note that the &quot;files&quot; outputted will include anything that is not</span>
<span class="sd">        a directory, such as links.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Root to recurse into</span>
<span class="sd">        maxdepth: int</span>
<span class="sd">            Maximum recursion depth. None means limitless, but not recommended</span>
<span class="sd">            on link-based file-systems.</span>
<span class="sd">        kwargs: passed to ``ls``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">full_dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">detail</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">listing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">listing</span><span class="p">:</span>
            <span class="c1"># each info name must be at least [path]/part , but here</span>
            <span class="c1"># we check also for names like [path]/part/</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pathname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;directory&quot;</span> <span class="ow">and</span> <span class="n">pathname</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
                <span class="c1"># do not include &quot;self&quot; path</span>
                <span class="n">full_dirs</span><span class="p">[</span><span class="n">pathname</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
                <span class="n">dirs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
            <span class="k">elif</span> <span class="n">pathname</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
                <span class="c1"># file-like with same name as give path</span>
                <span class="n">files</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>

        <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">path</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">dirs</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maxdepth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxdepth</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">maxdepth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">full_dirs</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.find"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.find">[documenti]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">withdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all files below path.</span>

<span class="sd">        Like posix ``find`` command without conditions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">        maxdepth: int or None</span>
<span class="sd">            If not None, the maximum number of levels to descend</span>
<span class="sd">        withdirs: bool</span>
<span class="sd">            Whether to include directory paths in the output. This is True</span>
<span class="sd">            when used by glob, but users usually only want files.</span>
<span class="sd">        kwargs are passed to ``ls``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: allow equivalent of -name parameter</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">withdirs</span><span class="p">:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dirs</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="c1"># walk works on directories, but find should also return [path]</span>
            <span class="c1"># when path happens to be a file</span>
            <span class="n">out</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span></div>

<div class="viewcode-block" id="AbstractFileSystem.du"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.du">[documenti]</a>    <span class="k">def</span> <span class="nf">du</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Space used by files within a path</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">        total: bool</span>
<span class="sd">            whether to sum all the file sizes</span>
<span class="sd">        maxdepth: int or None</span>
<span class="sd">            maximum number of directory levels to descend, None for unlimited.</span>
<span class="sd">        kwargs: passed to ``ls``</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict of {fn: size} if total=False, or int otherwise, where numbers</span>
<span class="sd">        refer to bytes used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">sizes</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sizes</span></div>

<div class="viewcode-block" id="AbstractFileSystem.glob"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.glob">[documenti]</a>    <span class="k">def</span> <span class="nf">glob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find files by glob-matching.</span>

<span class="sd">        If the path ends with &#39;/&#39; and does not contain &quot;*&quot;, it is essentially</span>
<span class="sd">        the same as ``ls(path)``, returning only files.</span>

<span class="sd">        We support ``&quot;**&quot;``,</span>
<span class="sd">        ``&quot;?&quot;`` and ``&quot;[..]&quot;``. We do not support ^ for pattern negation.</span>

<span class="sd">        Search path names that contain embedded characters special to this</span>
<span class="sd">        implementation of glob may not produce expected results;</span>
<span class="sd">        e.g., &#39;foo/bar/*starredfilename*&#39;.</span>

<span class="sd">        kwargs are passed to ``ls``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">re</span>

        <span class="n">ends</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">indstar</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">indques</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">indbrace</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">indstar</span><span class="p">,</span> <span class="n">indques</span><span class="p">,</span> <span class="n">indbrace</span><span class="p">)</span>

        <span class="n">detail</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_magic</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">path</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ends</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">+=</span> <span class="s2">&quot;/*&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[]</span>  <span class="c1"># glob of non-existent returns empty</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[:</span><span class="n">ind</span><span class="p">]:</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span> <span class="n">ind2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="n">path</span><span class="p">[</span><span class="n">ind2</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="s2">&quot;**&quot;</span> <span class="ow">in</span> <span class="n">path</span> <span class="k">else</span> <span class="n">path</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">allpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">withdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Escape characters special to python regex, leaving our supported</span>
        <span class="c1"># special characters in place.</span>
        <span class="c1"># See https://www.gnu.org/software/bash/manual/html_node/Pattern-Matching.html</span>
        <span class="c1"># for shell globbing details.</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;^&quot;</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\.&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\+&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\(&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\)&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\|&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\^&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\$&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\{&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\}&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;$&quot;</span>
        <span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[*]</span><span class="si">{2}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;=PLACEHOLDER=&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[*]&quot;</span><span class="p">,</span> <span class="s2">&quot;[^/]*&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=PLACEHOLDER=&quot;</span><span class="p">,</span> <span class="s2">&quot;.*&quot;</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">p</span><span class="p">:</span> <span class="n">allpaths</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allpaths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.exists"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.exists">[documenti]</a>    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is there a file at the given path&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="c1"># any exception allowed bar FileNotFoundError?</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AbstractFileSystem.lexists"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.lexists">[documenti]</a>    <span class="k">def</span> <span class="nf">lexists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If there is a file at the given path (including</span>
<span class="sd">        broken links)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.info"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.info">[documenti]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Give details of entry at path</span>

<span class="sd">        Returns a single dictionary, with exactly the same information as ``ls``</span>
<span class="sd">        would with ``detail=True``.</span>

<span class="sd">        The default implementation should calls ls and could be overridden by a</span>
<span class="sd">        shortcut. kwargs are passed on to ```ls()``.</span>

<span class="sd">        Some file systems might not be able to measure the file&#39;s size, in</span>
<span class="sd">        which case, the returned dict will include ``&#39;size&#39;: None``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict with keys: name (full path in the FS), size (in bytes), type (file,</span>
<span class="sd">        directory, or something else) and other FS-specific keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">path</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="n">o</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">path</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;size&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">out1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">out1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;directory&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.checksum"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.checksum">[documenti]</a>    <span class="k">def</span> <span class="nf">checksum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unique value for current version of file</span>

<span class="sd">        If the checksum is the same from one moment to another, the contents</span>
<span class="sd">        are guaranteed to be the same. If the checksum changes, the contents</span>
<span class="sd">        *might* have changed.</span>

<span class="sd">        This should normally be overridden; default will probably capture</span>
<span class="sd">        creation/modification timestamp (which would be good) or maybe</span>
<span class="sd">        access timestamp (which would be bad)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">)),</span> <span class="mi">16</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.size"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.size">[documenti]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Size in bytes of file&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.sizes"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.sizes">[documenti]</a>    <span class="k">def</span> <span class="nf">sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Size in bytes of each file in a list of paths&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span></div>

<div class="viewcode-block" id="AbstractFileSystem.isdir"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.isdir">[documenti]</a>    <span class="k">def</span> <span class="nf">isdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this entry directory-like?&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;directory&quot;</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AbstractFileSystem.isfile"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.isfile">[documenti]</a>    <span class="k">def</span> <span class="nf">isfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this entry file-like?&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AbstractFileSystem.cat_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.cat_file">[documenti]</a>    <span class="k">def</span> <span class="nf">cat_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the content of a file</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: URL of file on this filesystems</span>
<span class="sd">        start, end: int</span>
<span class="sd">            Bytes limits of the read. If negative, backwards from end,</span>
<span class="sd">            like usual python slices. Either can be None for start or</span>
<span class="sd">            end of file, respectively</span>
<span class="sd">        kwargs: passed to ``open()``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># explicitly set buffering off?</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">start</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">end</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractFileSystem.pipe_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.pipe_file">[documenti]</a>    <span class="k">def</span> <span class="nf">pipe_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the bytes of given file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.pipe"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.pipe">[documenti]</a>    <span class="k">def</span> <span class="nf">pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Put value into path</span>

<span class="sd">        (counterpart to ``cat``)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: string or dict(str, bytes)</span>
<span class="sd">            If a string, a single remote location to put ``value`` bytes; if a dict,</span>
<span class="sd">            a mapping of {path: bytesvalue}.</span>
<span class="sd">        value: bytes, optional</span>
<span class="sd">            If using a single path, these are the bytes to put there. Ignored if</span>
<span class="sd">            ``path`` is a dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipe_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">path</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pipe_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;path must be str or dict&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.cat_ranges"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.cat_ranges">[documenti]</a>    <span class="k">def</span> <span class="nf">cat_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">max_gap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">starts</span> <span class="o">=</span> <span class="p">[</span><span class="n">starts</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ends</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">starts</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">)]</span></div>

<div class="viewcode-block" id="AbstractFileSystem.cat"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.cat">[documenti]</a>    <span class="k">def</span> <span class="nf">cat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fetch (potentially multiple) paths&#39; contents</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        recursive: bool</span>
<span class="sd">            If True, assume the path(s) are directories, and get all the</span>
<span class="sd">            contained files</span>
<span class="sd">        on_error : &quot;raise&quot;, &quot;omit&quot;, &quot;return&quot;</span>
<span class="sd">            If raise, an underlying exception will be raised (converted to KeyError</span>
<span class="sd">            if the type is in self.missing_exceptions); if omit, keys with exception</span>
<span class="sd">            will simply not be included in the output; if &quot;return&quot;, all keys are</span>
<span class="sd">            included in the output, but the value will be bytes or an exception</span>
<span class="sd">            instance.</span>
<span class="sd">        kwargs: passed to cat_file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict of {path: contents} if there are multiple paths</span>
<span class="sd">        or the path has been otherwise expanded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_file</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.get_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.get_file">[documenti]</a>    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_DEFAULT_CALLBACK</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy single remote file to local&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
            <span class="n">callback</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">)</span>
                    <span class="n">segment_len</span> <span class="o">=</span> <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">callback</span><span class="o">.</span><span class="n">relative_update</span><span class="p">(</span><span class="n">segment_len</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.get"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.get">[documenti]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_DEFAULT_CALLBACK</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy file(s) to local.</span>

<span class="sd">        Copies a specific file or tree of files (if recursive=True). If lpath</span>
<span class="sd">        ends with a &quot;/&quot;, it will be assumed to be a directory, and target files</span>
<span class="sd">        will go within. Can submit a list of paths, which may be glob-patterns</span>
<span class="sd">        and will be expanded.</span>

<span class="sd">        Calls get_file for each source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.implementations.local</span> <span class="kn">import</span> <span class="n">make_path_posix</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="n">make_path_posix</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span>
        <span class="n">rpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>
        <span class="n">lpaths</span> <span class="o">=</span> <span class="n">other_paths</span><span class="p">(</span><span class="n">rpaths</span><span class="p">,</span> <span class="n">lpath</span><span class="p">)</span>

        <span class="n">callback</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lpaths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span> <span class="ow">in</span> <span class="n">callback</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lpaths</span><span class="p">,</span> <span class="n">rpaths</span><span class="p">)):</span>
            <span class="n">callback</span><span class="o">.</span><span class="n">branch</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.put_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.put_file">[documenti]</a>    <span class="k">def</span> <span class="nf">put_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_DEFAULT_CALLBACK</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy single file to remote&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">lpath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">callback</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="n">f1</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fspath</span><span class="p">(</span><span class="n">rpath</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f2</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">f1</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">)</span>
                    <span class="n">segment_len</span> <span class="o">=</span> <span class="n">f2</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">callback</span><span class="o">.</span><span class="n">relative_update</span><span class="p">(</span><span class="n">segment_len</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.put"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.put">[documenti]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">_DEFAULT_CALLBACK</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy file(s) from local.</span>

<span class="sd">        Copies a specific file or tree of files (if recursive=True). If rpath</span>
<span class="sd">        ends with a &quot;/&quot;, it will be assumed to be a directory, and target files</span>
<span class="sd">        will go within.</span>

<span class="sd">        Calls put_file for each source.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.implementations.local</span> <span class="kn">import</span> <span class="n">LocalFileSystem</span><span class="p">,</span> <span class="n">make_path_posix</span>

        <span class="n">rpath</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">rpath</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rpath</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">lpath</span> <span class="o">=</span> <span class="n">make_path_posix</span><span class="p">(</span><span class="n">lpath</span><span class="p">)</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">LocalFileSystem</span><span class="p">()</span>
        <span class="n">lpaths</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>
        <span class="n">rpaths</span> <span class="o">=</span> <span class="n">other_paths</span><span class="p">(</span>
            <span class="n">lpaths</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">exists</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rpath</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">callback</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpaths</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span> <span class="ow">in</span> <span class="n">callback</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lpaths</span><span class="p">,</span> <span class="n">rpaths</span><span class="p">)):</span>
            <span class="n">callback</span><span class="o">.</span><span class="n">branch</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put_file</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.head"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.head">[documenti]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the first ``size`` bytes from file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.tail"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.tail">[documenti]</a>    <span class="k">def</span> <span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1024</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the last ``size`` bytes from file&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="n">f</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractFileSystem.cp_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.cp_file">[documenti]</a>    <span class="k">def</span> <span class="nf">cp_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="AbstractFileSystem.copy"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.copy">[documenti]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy within two locations in the filesystem</span>

<span class="sd">        on_error : &quot;raise&quot;, &quot;ignore&quot;</span>
<span class="sd">            If raise, any not-found exceptions will be raised; if ignore any</span>
<span class="sd">            not-found exceptions will cause the path to be skipped; defaults to</span>
<span class="sd">            raise unless recursive is true, where the default is ignore</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">on_error</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">on_error</span> <span class="o">=</span> <span class="s2">&quot;ignore&quot;</span>
        <span class="k">elif</span> <span class="n">on_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">on_error</span> <span class="o">=</span> <span class="s2">&quot;raise&quot;</span>

        <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span>
        <span class="n">path2</span> <span class="o">=</span> <span class="n">other_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">path2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">path2</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cp_file</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_error</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
                    <span class="k">raise</span></div>

<div class="viewcode-block" id="AbstractFileSystem.expand_path"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.expand_path">[documenti]</a>    <span class="k">def</span> <span class="nf">expand_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Turn one or more globs or directories into a list of all matching paths</span>
<span class="sd">        to files or directories.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">([</span><span class="n">path</span><span class="p">],</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># reduce depth on each recursion level unless None or 0</span>
            <span class="n">maxdepth</span> <span class="o">=</span> <span class="n">maxdepth</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">maxdepth</span> <span class="k">else</span> <span class="n">maxdepth</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">has_magic</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">bit</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                    <span class="n">out</span> <span class="o">|=</span> <span class="n">bit</span>
                    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">bit</span><span class="p">),</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">recursive</span><span class="p">:</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">,</span> <span class="n">withdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="n">out</span> <span class="o">|=</span> <span class="n">rec</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recursive</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                    <span class="c1"># should only check once, for the root</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbstractFileSystem.mv"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.mv">[documenti]</a>    <span class="k">def</span> <span class="nf">mv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move file(s) from one location to another&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.rm_file"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.rm_file">[documenti]</a>    <span class="k">def</span> <span class="nf">rm_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete a file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rm</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_rm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete one file&quot;&quot;&quot;</span>
        <span class="c1"># this is the old name for the method, prefer rm_file</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="AbstractFileSystem.rm"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.rm">[documenti]</a>    <span class="k">def</span> <span class="nf">rm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str or list of str</span>
<span class="sd">            File(s) to delete.</span>
<span class="sd">        recursive: bool</span>
<span class="sd">            If file(s) are directories, recursively delete contents and then</span>
<span class="sd">            also remove the directory</span>
<span class="sd">        maxdepth: int or None</span>
<span class="sd">            Depth to pass to walk for finding files to delete, if recursive.</span>
<span class="sd">            If None, there will be no limit and infinite recursion may be</span>
<span class="sd">            possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rm_file</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">root_marker</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">root_marker</span> <span class="o">+</span> <span class="n">parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">root_marker</span>

    <span class="k">def</span> <span class="nf">_open</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span>
        <span class="n">block_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return raw bytes-mode file-like from the file-system&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AbstractBufferedFile</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">,</span>
            <span class="n">block_size</span><span class="p">,</span>
            <span class="n">autocommit</span><span class="p">,</span>
            <span class="n">cache_options</span><span class="o">=</span><span class="n">cache_options</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="AbstractFileSystem.open"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.open">[documenti]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span>
        <span class="n">block_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cache_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compression</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a file-like object from the filesystem</span>

<span class="sd">        The resultant instance must function correctly in a context ``with``</span>
<span class="sd">        block.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            Target file</span>
<span class="sd">        mode: str like &#39;rb&#39;, &#39;w&#39;</span>
<span class="sd">            See builtin ``open()``</span>
<span class="sd">        block_size: int</span>
<span class="sd">            Some indication of buffering - this is a value in bytes</span>
<span class="sd">        cache_options : dict, optional</span>
<span class="sd">            Extra arguments to pass through to the cache.</span>
<span class="sd">        compression: string or None</span>
<span class="sd">            If given, open file using compression codec. Can either be a compression</span>
<span class="sd">            name (a key in ``fsspec.compression.compr``) or &quot;infer&quot; to guess the</span>
<span class="sd">            compression from the filename suffix.</span>
<span class="sd">        encoding, errors, newline: passed on to TextIOWrapper for text mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">io</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_protocol</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;b&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;b&quot;</span>

            <span class="n">text_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="s2">&quot;newline&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span>
                    <span class="n">mode</span><span class="p">,</span>
                    <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">,</span>
                    <span class="n">cache_options</span><span class="o">=</span><span class="n">cache_options</span><span class="p">,</span>
                    <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="o">**</span><span class="n">text_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;autocommit&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intrans</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">block_size</span><span class="o">=</span><span class="n">block_size</span><span class="p">,</span>
                <span class="n">autocommit</span><span class="o">=</span><span class="n">ac</span><span class="p">,</span>
                <span class="n">cache_options</span><span class="o">=</span><span class="n">cache_options</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">compression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">fsspec.compression</span> <span class="kn">import</span> <span class="n">compr</span>
                <span class="kn">from</span> <span class="nn">fsspec.core</span> <span class="kn">import</span> <span class="n">get_compression</span>

                <span class="n">compression</span> <span class="o">=</span> <span class="n">get_compression</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">compression</span><span class="p">)</span>
                <span class="n">compress</span> <span class="o">=</span> <span class="n">compr</span><span class="p">[</span><span class="n">compression</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">compress</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ac</span> <span class="ow">and</span> <span class="s2">&quot;r&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="AbstractFileSystem.touch"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.touch">[documenti]</a>    <span class="k">def</span> <span class="nf">touch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create empty file, or update timestamp</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path: str</span>
<span class="sd">            file location</span>
<span class="sd">        truncate: bool</span>
<span class="sd">            If True, always set file size to 0; if False, update timestamp and</span>
<span class="sd">            leave file unchanged, if backend allows this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">truncate</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>  <span class="c1"># update timestamp, if possible</span></div>

<div class="viewcode-block" id="AbstractFileSystem.ukey"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.ukey">[documenti]</a>    <span class="k">def</span> <span class="nf">ukey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Hash of file properties, to tell if it has changed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sha256</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractFileSystem.read_block"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.read_block">[documenti]</a>    <span class="k">def</span> <span class="nf">read_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a block of bytes from</span>

<span class="sd">        Starting at ``offset`` of the file, read ``length`` bytes.  If</span>
<span class="sd">        ``delimiter`` is set then we ensure that the read starts and stops at</span>
<span class="sd">        delimiter boundaries that follow the locations ``offset`` and ``offset</span>
<span class="sd">        + length``.  If ``offset`` is zero then we start at zero.  The</span>
<span class="sd">        bytestring returned WILL include the end delimiter string.</span>

<span class="sd">        If offset+length is beyond the eof, reads to eof.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fn: string</span>
<span class="sd">            Path to filename</span>
<span class="sd">        offset: int</span>
<span class="sd">            Byte offset to start read</span>
<span class="sd">        length: int</span>
<span class="sd">            Number of bytes to read</span>
<span class="sd">        delimiter: bytes (optional)</span>
<span class="sd">            Ensure reading starts and stops at delimiter bytestring</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; fs.read_block(&#39;data/file.csv&#39;, 0, 13)  # doctest: +SKIP</span>
<span class="sd">        b&#39;Alice, 100\\nBo&#39;</span>
<span class="sd">        &gt;&gt;&gt; fs.read_block(&#39;data/file.csv&#39;, 0, 13, delimiter=b&#39;\\n&#39;)  # doctest: +SKIP</span>
<span class="sd">        b&#39;Alice, 100\\nBob, 200\\n&#39;</span>

<span class="sd">        Use ``length=None`` to read to the end of the file.</span>
<span class="sd">        &gt;&gt;&gt; fs.read_block(&#39;data/file.csv&#39;, 0, None, delimiter=b&#39;\\n&#39;)  # doctest: +SKIP</span>
<span class="sd">        b&#39;Alice, 100\\nBob, 200\\nCharlie, 300&#39;</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        utils.read_block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">size</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">offset</span>
            <span class="k">return</span> <span class="n">read_block</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.to_json"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.to_json">[documenti]</a>    <span class="k">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        JSON representation of this filesystem instance</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str: JSON structure with keys cls (the python location of this class),</span>
<span class="sd">            protocol (text name of this class&#39;s protocol, first one in case of</span>
<span class="sd">            multiple), args (positional args, usually empty), and all other</span>
<span class="sd">            kwargs as their own keys.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">json</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="n">proto</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="o">**</span><span class="p">{</span><span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">:</span> <span class="n">proto</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_args</span><span class="p">},</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_options</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.from_json"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.from_json">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="n">blob</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recreate a filesystem instance from JSON representation</span>

<span class="sd">        See ``.to_json()`` for the expected structure of the input</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blob: str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        file system instance, not necessarily of this particular class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">json</span>

        <span class="kn">from</span> <span class="nn">.registry</span> <span class="kn">import</span> <span class="n">_import_class</span><span class="p">,</span> <span class="n">get_filesystem_class</span>

        <span class="n">dic</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;protocol&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">_import_class</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cls&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">get_filesystem_class</span><span class="p">(</span><span class="n">protocol</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">dic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">()),</span> <span class="o">**</span><span class="n">dic</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_pyarrow_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a version of the FS instance which will be acceptable to pyarrow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># all instances already also derive from pyarrow</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="AbstractFileSystem.get_mapper"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.get_mapper">[documenti]</a>    <span class="k">def</span> <span class="nf">get_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create key/value store based on this file-system</span>

<span class="sd">        Makes a MutableMapping interface to the FS at the given root path.</span>
<span class="sd">        See ``fsspec.mapping.FSMap`` for further details.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.mapping</span> <span class="kn">import</span> <span class="n">FSMap</span>

        <span class="k">return</span> <span class="n">FSMap</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">create</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.clear_instance_cache"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.clear_instance_cache">[documenti]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_instance_cache</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the cache of filesystem instances.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Unless overridden by setting the ``cachable`` class attribute to False,</span>
<span class="sd">        the filesystem class stores a reference to newly created instances. This</span>
<span class="sd">        prevents Python&#39;s normal rules around garbage collection from working,</span>
<span class="sd">        since the instances refcount will not drop to zero until</span>
<span class="sd">        ``clear_instance_cache`` is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbstractFileSystem.created"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.created">[documenti]</a>    <span class="k">def</span> <span class="nf">created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the created timestamp of a file as a datetime.datetime&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="AbstractFileSystem.modified"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.modified">[documenti]</a>    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the modified timestamp of a file as a datetime.datetime&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

    <span class="c1"># ------------------------------------------------------------------------</span>
    <span class="c1"># Aliases</span>

<div class="viewcode-block" id="AbstractFileSystem.makedir"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.makedir">[documenti]</a>    <span class="k">def</span> <span class="nf">makedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">create_parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.mkdir`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">create_parents</span><span class="o">=</span><span class="n">create_parents</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.mkdirs"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.mkdirs">[documenti]</a>    <span class="k">def</span> <span class="nf">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.makedirs`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="n">exist_ok</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.listdir"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.listdir">[documenti]</a>    <span class="k">def</span> <span class="nf">listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.ls`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.cp"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.cp">[documenti]</a>    <span class="k">def</span> <span class="nf">cp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.copy`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.move"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.move">[documenti]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.mv`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.stat"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.stat">[documenti]</a>    <span class="k">def</span> <span class="nf">stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.info`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.disk_usage"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.disk_usage">[documenti]</a>    <span class="k">def</span> <span class="nf">disk_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.du`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">du</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.rename"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.rename">[documenti]</a>    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.mv`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.delete"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.delete">[documenti]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.rm`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="n">maxdepth</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.upload"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.upload">[documenti]</a>    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.put`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">lpath</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.download"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.download">[documenti]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of `AbstractFileSystem.get`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpath</span><span class="p">,</span> <span class="n">lpath</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFileSystem.sign"><a class="viewcode-back" href="../../ingestion.Connectors.html#ingestion.Connectors.AbstractFileSystem.sign">[documenti]</a>    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">expiration</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a signed URL representing the given path</span>

<span class="sd">        Some implementations allow temporary URLs to be generated, as a</span>
<span class="sd">        way of delegating credentials.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">             The path on the filesystem</span>
<span class="sd">        expiration : int</span>
<span class="sd">            Number of seconds to enable the URL for (if supported)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        URL : str</span>
<span class="sd">            The signed URL</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError : if method is not implemented for a filesystem</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Sign is not implemented for this filesystem&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_isfilestore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Originally inherited from pyarrow DaskFileSystem. Keeping this</span>
        <span class="c1"># here for backwards compatibility as long as pyarrow uses its</span>
        <span class="c1"># legacy fsspec-compatible filesystems and thus accepts fsspec</span>
        <span class="c1"># filesystems as well</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">class</span> <span class="nc">AbstractBufferedFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenient class to derive from to provide buffering</span>

<span class="sd">    In the case that the backend does not provide a pythonic file-like object</span>
<span class="sd">    already, this class contains much of the logic to build one. The only</span>
<span class="sd">    methods that need to be overridden are ``_upload_chunk``,</span>
<span class="sd">    ``_initiate_upload`` and ``_fetch_range``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
    <span class="n">_details</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fs</span><span class="p">,</span>
        <span class="n">path</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span>
        <span class="n">block_size</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cache_type</span><span class="o">=</span><span class="s2">&quot;readahead&quot;</span><span class="p">,</span>
        <span class="n">cache_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Template for files with buffered reading and writing</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fs: instance of FileSystem</span>
<span class="sd">        path: str</span>
<span class="sd">            location in file-system</span>
<span class="sd">        mode: str</span>
<span class="sd">            Normal file modes. Currently only &#39;wb&#39;, &#39;ab&#39; or &#39;rb&#39;. Some file</span>
<span class="sd">            systems may be read-only, and some may not support append.</span>
<span class="sd">        block_size: int</span>
<span class="sd">            Buffer size for reading or writing, &#39;default&#39; for class default</span>
<span class="sd">        autocommit: bool</span>
<span class="sd">            Whether to write to final destination; may only impact what</span>
<span class="sd">            happens when file is being closed.</span>
<span class="sd">        cache_type: {&quot;readahead&quot;, &quot;none&quot;, &quot;mmap&quot;, &quot;bytes&quot;}, default &quot;readahead&quot;</span>
<span class="sd">            Caching policy in read mode. See the definitions in ``core``.</span>
<span class="sd">        cache_options : dict</span>
<span class="sd">            Additional options passed to the constructor for the cache specified</span>
<span class="sd">            by `cache_type`.</span>
<span class="sd">        size: int</span>
<span class="sd">            If given and in read mode, suppressed having to look up the file size</span>
<span class="sd">        kwargs:</span>
<span class="sd">            Gets stored as self.kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.core</span> <span class="kn">import</span> <span class="n">caches</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_BLOCK_SIZE</span> <span class="k">if</span> <span class="n">block_size</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="k">else</span> <span class="n">block_size</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autocommit</span> <span class="o">=</span> <span class="n">autocommit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">cache_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache_options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s2">&quot;trim&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Passing &#39;trim&#39; to control the cache behavior has been deprecated. &quot;</span>
                <span class="s2">&quot;Specify it within the &#39;cache_options&#39; argument instead.&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cache_options</span><span class="p">[</span><span class="s2">&quot;trim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;trim&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;ab&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;File mode not supported&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">caches</span><span class="p">[</span><span class="n">cache_type</span><span class="p">](</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">cache_options</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forced</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_details</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_details</span>

    <span class="nd">@details</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_details</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_unstrip_protocol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get around this attr being read-only in IOBase</span>
        <span class="c1"># use getattr here, since this can be called during del</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_closed&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="nd">@closed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="n">c</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokenize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Files are equal if they have the same checksum, only in read mode&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span> <span class="ow">and</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move from temp to final destination&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">discard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Throw away temporary file&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;File information about this path&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;r&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Info not available while writing&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Current file location&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">whence</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set current file location</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loc: int</span>
<span class="sd">            byte location</span>
<span class="sd">        whence: {0, 1, 2}</span>
<span class="sd">            from start of file, current location or end of file, resp.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">ESPIPE</span><span class="p">,</span> <span class="s2">&quot;Seek only available in read mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nloc</span> <span class="o">=</span> <span class="n">loc</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+</span> <span class="n">loc</span>
        <span class="k">elif</span> <span class="n">whence</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">loc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid whence (</span><span class="si">%s</span><span class="s2">, should be 0, 1 or 2)&quot;</span> <span class="o">%</span> <span class="n">whence</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nloc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Seek before start of file&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">nloc</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to buffer.</span>

<span class="sd">        Buffer only sent on flush() or if buffer is greater than</span>
<span class="sd">        or equal to blocksize.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: bytes</span>
<span class="sd">            Set of bytes to be written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">}:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not in write mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;I/O operation on closed file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This file has been force-flushed, can only close&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+=</span> <span class="n">out</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write buffered data to backend store.</span>

<span class="sd">        Writes the current buffer, if it is larger than the block-size, or if</span>
<span class="sd">        the file is being closed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force: bool</span>
<span class="sd">            When closing, write the last block even if it is smaller than</span>
<span class="sd">            blocks are allowed to be. Disallows further writing to this file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Flush on closed file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Force flush cannot be called more than once&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forced</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">}:</span>
            <span class="c1"># no-op to flush on read-mode</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">:</span>
            <span class="c1"># Defer write on small block</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Initialize a multipart upload</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initiate_upload</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_upload_chunk</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="n">force</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_upload_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write one part of a multi-block file upload</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        final: bool</span>
<span class="sd">            This is the last block, so should complete file, if</span>
<span class="sd">            self.autocommit is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># may not yet have been initialized, may need to call _initialize_upload</span>

    <span class="k">def</span> <span class="nf">_initiate_upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create remote file/upload&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_fetch_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the specified set of bytes from remote&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return data from cache, or fetch pieces as necessary</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        length: int (-1)</span>
<span class="sd">            Number of bytes to read; if &lt;0, all remaining bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;rb&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not in read mode&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;I/O operation on closed file.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> read: </span><span class="si">%i</span><span class="s2"> - </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+</span> <span class="n">length</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># don&#39;t even bother calling fetch</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">_fetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">readinto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mirrors builtin file&#39;s readinto method</span>

<span class="sd">        https://docs.python.org/3/library/io.html#io.RawIOBase.readinto</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">nbytes</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readuntil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return data between current position and first occurrence of char</span>

<span class="sd">        char is included in the output, except if the end of the tile is</span>
<span class="sd">        encountered first.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        char: bytes</span>
<span class="sd">            Thing to find</span>
<span class="sd">        blocks: None or int</span>
<span class="sd">            How much to read in each go. Defaults to file blocksize - which may</span>
<span class="sd">            mean a new read on every call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blocks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">[:</span> <span class="n">found</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">found</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read until first occurrence of newline character</span>

<span class="sd">        Note that, because of character encoding, this is not necessarily a</span>
<span class="sd">        true line ending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all data, split by the newline character&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># return list(self)  ???</span>

    <span class="k">def</span> <span class="nf">readinto1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close file</span>

<span class="sd">        Finalizes writes, discards cache</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_unclosable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forced</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">_parent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether opened for reading&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rb&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether is seekable (only in read mode)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whether opened for writing&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;wb&quot;</span><span class="p">,</span> <span class="s2">&quot;ab&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;File-like object </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PAT</a></h1>








<h3>Navigazione</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Codice del modulo</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Ricerca veloce</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Giuseppe Ventura.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>