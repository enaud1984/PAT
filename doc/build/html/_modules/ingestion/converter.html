
<!DOCTYPE html>

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ingestion.converter &#8212; PAT 0.1.0 documentazione</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/translations.js"></script>
    <link rel="index" title="Indice" href="../../genindex.html" />
    <link rel="search" title="Cerca" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Codice sorgente per ingestion.converter</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">,</span> <span class="n">DecimalType</span>

<span class="c1">#lista dei tipi gestiti</span>
<span class="n">data_types</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;array&quot;</span><span class="p">,</span>
    <span class="s2">&quot;binary&quot;</span><span class="p">,</span>
    <span class="s2">&quot;byte&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date&quot;</span><span class="p">,</span>
    <span class="s2">&quot;decimal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;double&quot;</span><span class="p">,</span>
    <span class="s2">&quot;float&quot;</span><span class="p">,</span>
    <span class="s2">&quot;int&quot;</span><span class="p">,</span>
    <span class="s2">&quot;long&quot;</span><span class="p">,</span>
    <span class="s2">&quot;short&quot;</span><span class="p">,</span>
    <span class="s2">&quot;string&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;datetime&quot;</span>
<span class="p">]</span>
<span class="n">data_type_default</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span> <span class="c1">#tipo di dfault se non inserito nello schema</span>

<span class="n">J_NODE</span> <span class="o">=</span> <span class="s2">&quot;NODE&quot;</span>
<span class="n">J_LEAF</span> <span class="o">=</span> <span class="s2">&quot;LEAF&quot;</span>
<span class="n">J_NODE_ARRAY</span> <span class="o">=</span> <span class="s2">&quot;NODE_ARRAY&quot;</span>
<span class="n">J_LEAF_ARRAY</span> <span class="o">=</span> <span class="s2">&quot;LEAF_ARRAY&quot;</span>

<span class="n">CAST_ALL_STRING</span> <span class="o">=</span> <span class="s2">&quot;CAST_ALL_STRING&quot;</span>
<span class="n">CAST_DATA_TYPE</span> <span class="o">=</span> <span class="s2">&quot;CAST_DATA_TYPE&quot;</span>
<span class="n">CAST_CSV</span> <span class="o">=</span> <span class="s2">&quot;CAST_CSV&quot;</span>

<div class="viewcode-block" id="JError"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JError">[documenti]</a><span class="k">class</span> <span class="nc">JError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="c1"># input key_ :</span>
<span class="c1"># chiave dello schema nel formato : *+JSON_NAME#NEW_NAME(type|info_type)</span>
<span class="c1"># * --&gt; opzionale, implica che il campo e&#39; obbligatorio</span>
<span class="c1"># + --&gt; opzionale, unisce i contenuti degli array</span>
<span class="c1"># JSON_NAME --&gt; obbligatorio, nome della campo json</span>
<span class="c1"># NEW_NAME --&gt; opzionale, nome nuovo che viene inseriti nell&#39; header , se non inserito viene utilizzato JSON_NAME</span>
<span class="c1"># type --&gt; opzionale, tipo del dato (sono considerati valisi solo quelli contenuti in data_types)</span>
<span class="c1"># info_type --&gt; da definire</span>

<span class="c1"># input json_type :</span>
<span class="c1"># L : list</span>
<span class="c1"># D : dict</span>
<span class="c1"># V : value</span>

<div class="viewcode-block" id="JKey"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JKey">[documenti]</a><span class="k">class</span> <span class="nc">JKey</span> <span class="p">:</span>
    <span class="n">full_name</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">real_name</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">new_name</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">key_name</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">json_type</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">data_type</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">data_type_detail</span> <span class="p">:</span> <span class="kc">None</span>
    <span class="n">isMandatory</span> <span class="p">:</span> <span class="kc">False</span>
    <span class="n">isUnion</span> <span class="p">:</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key_</span><span class="p">,</span> <span class="n">json_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">json_type</span> <span class="o">=</span> <span class="n">json_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type_detail</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isMandatory</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isUnion</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isForceDefault</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="n">key_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">real_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">key_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">key_split</span> <span class="o">=</span> <span class="n">key_</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


            <span class="n">i_open</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="c1"># get the position of delimiter [</span>
            <span class="n">i_close</span><span class="o">=</span><span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="c1"># get the position of delimiter ]</span>

            <span class="k">if</span> <span class="n">i_open</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">i_close</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span>
                <span class="n">d_type</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i_open</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i_close</span><span class="p">]</span>
                <span class="n">d_type_detail</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">d_type</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">d_type_split</span> <span class="o">=</span> <span class="n">d_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_type_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">d_type</span> <span class="o">=</span> <span class="n">d_type_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">d_type_detail</span> <span class="o">=</span> <span class="n">d_type_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">d_type</span> <span class="ow">in</span> <span class="n">data_types</span> <span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;field type is not valid : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d_type</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">d_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_type_detail</span> <span class="o">=</span> <span class="n">d_type_detail</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">data_type_default</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">first_</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">first_</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isMandatory</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">first_</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isUnion</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">elif</span> <span class="n">first_</span> <span class="o">==</span> <span class="s2">&quot;!&quot;</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isForceDefault</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1">#remove</span>
            <span class="n">itemSplit</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemSplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">real_name</span> <span class="o">=</span> <span class="n">itemSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">itemSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">itemSplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">real_name</span> <span class="o">=</span> <span class="n">itemSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_name</span> <span class="o">=</span> <span class="n">itemSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">key_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key_name</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">key_split</span><span class="p">)</span>

<div class="viewcode-block" id="JKey.isValid"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JKey.isValid">[documenti]</a>    <span class="k">def</span> <span class="nf">isValid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isUnion</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_type</span> <span class="o">!=</span> <span class="n">J_NODE_ARRAY</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_type</span> <span class="o">!=</span> <span class="n">J_LEAF_ARRAY</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JError</span><span class="p">(</span><span class="s2">&quot;Use tag + only for list [] : </span><span class="si">{}</span><span class="s2"> is a </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_type</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;full_name:</span><span class="si">% s</span><span class="s2"> real_name:</span><span class="si">% s</span><span class="s2"> new_name:</span><span class="si">% s</span><span class="s2"> key_name:</span><span class="si">% s</span><span class="s2"> json_type:</span><span class="si">% s</span><span class="s2"> data_type:</span><span class="si">% s</span><span class="s2"> data_type_detail:</span><span class="si">% s</span><span class="s2"> isMandatory:</span><span class="si">% s</span><span class="s2"> isUnion:</span><span class="si">% s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">real_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">json_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type_detail</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isMandatory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isUnion</span><span class="p">)</span> 

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;full_name:</span><span class="si">% s</span><span class="s2"> real_name:</span><span class="si">% s</span><span class="s2"> new_name:</span><span class="si">% s</span><span class="s2"> key_name:</span><span class="si">% s</span><span class="s2"> json_type:</span><span class="si">% s</span><span class="s2"> data_type:</span><span class="si">% s</span><span class="s2"> data_type_detail:</span><span class="si">% s</span><span class="s2"> isMandatory:</span><span class="si">% s</span><span class="s2"> isUnion:</span><span class="si">% s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">real_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">key_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">json_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type_detail</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isMandatory</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">isUnion</span><span class="p">)</span> </div>

<div class="viewcode-block" id="JsonUtils"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonUtils">[documenti]</a><span class="k">class</span> <span class="nc">JsonUtils</span> <span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    obj : oggetto da trasformare</span>
<span class="sd">    jKey : info sull&#39;oggetto</span>
<span class="sd">    casttype :</span>
<span class="sd">        CAST_ALL_STRING : trasforma sempre l&#39;oggetto in stringa</span>
<span class="sd">        CAST_DATA_TYPE : trasforma nell&#39;oggetto definito nel jKey</span>
<span class="sd">        CAST_CSV : trasforma tutto in stringa tranne i numerici</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonUtils.castObj"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonUtils.castObj">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">castObj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">jKey</span><span class="p">,</span> <span class="n">casttype</span><span class="o">=</span><span class="n">CAST_ALL_STRING</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">casttype</span> <span class="o">==</span> <span class="n">CAST_ALL_STRING</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;NULL&quot;</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">casttype</span> <span class="o">==</span> <span class="n">CAST_ALL_STRING</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">casttype</span> <span class="o">==</span> <span class="n">CAST_DATA_TYPE</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;double&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;bytes&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type_detail</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S+01:00&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type_detail</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">casttype</span> <span class="o">==</span> <span class="n">CAST_CSV</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;long&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;double&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonUtils.loads"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonUtils.loads">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">content</span></div>

<div class="viewcode-block" id="JsonUtils.getCsvObj"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonUtils.getCsvObj">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getCsvObj</span><span class="p">(</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="s2">&quot;NULL&quot;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">obj</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="c1">################################################</span>
    <span class="c1">#######      Static Public Methods       #######</span>
    <span class="c1">################################################</span>
<div class="viewcode-block" id="JsonUtils.dataToStr"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonUtils.dataToStr">[documenti]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dataToStr</span><span class="p">(</span> <span class="n">csvData</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quoteFields</span><span class="o">=</span><span class="s2">&quot;smart&quot;</span><span class="p">,</span> <span class="n">lineSeparator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">csvData</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">csvData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;csvData is not a list-of-lists. dataToStr is meant to convert the return of &quot;extractData&quot; method to csv data.&#39;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">JsonUtils</span><span class="o">.</span><span class="n">getCsvObj</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">])</span> <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">csvData</span><span class="p">]</span>
        <span class="c1">#lines = [separator.join([&#39;&quot;%s&quot;&#39; % (str(item).replace(&#39;&quot;&#39;, &#39;&quot;&quot;&#39;),) for item in items]) for items in csvData]</span>

        <span class="k">return</span> <span class="n">lineSeparator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="JsonConverter"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter">[documenti]</a><span class="k">class</span> <span class="nc">JsonConverter</span> <span class="p">:</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">schema_spark</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">shema_detail</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header_detail</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">J_UNION_DELIMITER</span> <span class="o">=</span> <span class="s2">&quot;|&quot;</span>
    <span class="n">J_NULL_VALUE</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># il valore che assume il campo Stringa null</span>
    <span class="c1">#J_NULL_VALUE = &#39;NULL&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="c1">#Schema iniziale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchemaDetail</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">schema</span><span class="p">))</span>
        <span class="c1">#self.setSchemaDetail(copy.deepcopy(schema))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">schema</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_detail</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHeaderDetail</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema_spark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSparkSchema</span><span class="p">()</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        print(&quot;self.init_schema == {}&quot;.format(self.init_schema))</span>
<span class="sd">        print(&quot;self.schema == {}&quot;.format(self.schema))</span>
<span class="sd">        print(&quot;self.header_detail == {}&quot;.format(self.header_detail))</span>
<span class="sd">        print(&quot;self.shema_detail == {}&quot;.format(self.shema_detail))</span>
<span class="sd">        &#39;&#39;&#39;</span>

<div class="viewcode-block" id="JsonConverter.getSchemaDetail"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getSchemaDetail">[documenti]</a>    <span class="k">def</span> <span class="nf">getSchemaDetail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_schema</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">shema_detail_local</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">shema_detail_local</span><span class="p">[</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">]</span><span class="o">=</span><span class="n">jKey</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">jKey</span><span class="o">.</span><span class="n">json_type</span> <span class="o">=</span> <span class="n">J_NODE</span>
            <span class="n">shema_detail_local</span><span class="p">[</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">]</span><span class="o">=</span><span class="n">jKey</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">json_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">shema_detail_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchemaDetail</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">shema_detail_local</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shema_detail_in</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">jKey</span><span class="o">.</span><span class="n">json_type</span> <span class="o">=</span> <span class="n">J_NODE_ARRAY</span>
            <span class="n">shema_detail_local</span><span class="p">[</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">]</span><span class="o">=</span><span class="n">jKey</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_schema</span><span class="p">:</span>
                <span class="n">shema_detail_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchemaDetail</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
                <span class="n">shema_detail_local</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shema_detail_in</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">jKey</span><span class="o">.</span><span class="n">json_type</span> <span class="o">=</span> <span class="n">J_LEAF_ARRAY</span>
                    <span class="n">shema_detail_local</span><span class="p">[</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">]</span><span class="o">=</span><span class="n">jKey</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">jKey</span><span class="o">.</span><span class="n">json_type</span> <span class="o">=</span> <span class="n">J_LEAF</span>
            <span class="n">shema_detail_local</span><span class="p">[</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">jKey</span>

        <span class="n">jKey</span><span class="o">.</span><span class="n">isValid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">shema_detail_local</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    def setSchemaDetail(self,json_schema,key=None):</span>
<span class="sd">        if key is not None :</span>
<span class="sd">            jKey = JKey(key)</span>
<span class="sd">            self.shema_detail[jKey.key_name]=jKey</span>
<span class="sd">            key = jKey.key_name</span>
<span class="sd">        else :</span>
<span class="sd">            jKey = JKey(None)</span>
<span class="sd">            jKey.key_name = &quot;&quot;</span>
<span class="sd">            key = &quot;&quot;</span>

<span class="sd">        if type(json_schema) is dict:</span>
<span class="sd">            jKey.json_type = J_NODE</span>
<span class="sd">            self.shema_detail[jKey.key_name]=jKey</span>
<span class="sd">            for name, v in sorted(json_schema.items()):</span>
<span class="sd">                self.setSchemaDetail(json_schema[name],key + &quot;/&quot; + name)</span>
<span class="sd">        elif type(json_schema) is list:</span>
<span class="sd">            jKey.json_type = J_NODE_ARRAY</span>
<span class="sd">            self.shema_detail[jKey.key_name]=jKey</span>
<span class="sd">            for name in json_schema:</span>
<span class="sd">                self.setSchemaDetail(json_schema[0],key + &quot;/&quot; + &quot;@&quot;)</span>
<span class="sd">                if name is None :</span>
<span class="sd">                    jKey.json_type = J_LEAF_ARRAY</span>
<span class="sd">                    self.shema_detail[jKey.key_name]=jKey</span>
<span class="sd">        else :</span>
<span class="sd">            jKey.json_type = J_LEAF</span>
<span class="sd">            self.shema_detail[jKey.key_name] = jKey</span>

<span class="sd">        jKey.isValid()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    restituisce una riga con l&#39;header estratto dallo schema</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonConverter.getHeaderDetail"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getHeaderDetail">[documenti]</a>    <span class="k">def</span> <span class="nf">getHeaderDetail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_schema</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1">#jKey = JKey(key)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">current_line</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1">#for name in json_schema:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">json_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">inner_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHeaderDetail</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">current_line</span> <span class="o">=</span> <span class="n">current_line</span> <span class="o">+</span> <span class="n">inner_line</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#for name in sorted(json_schema) :</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">json_schema</span><span class="p">:</span>
                <span class="n">inner_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHeaderDetail</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
                    <span class="n">inner_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">jKey</span><span class="p">]</span>

                <span class="n">current_line</span> <span class="o">=</span> <span class="n">inner_line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">jKey</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">current_line</span></div>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Restituisce una lista con gli header</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonConverter.getHeader"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getHeader">[documenti]</a>    <span class="k">def</span> <span class="nf">getHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_detail</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">normalize</span> <span class="p">:</span>
              <span class="n">normalized</span> <span class="o">=</span> <span class="n">hd</span><span class="o">.</span><span class="n">new_name</span>
              <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
              <span class="n">normalized</span> <span class="o">=</span> <span class="n">normalized</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
              <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
              <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">new_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span></div>



    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Crea un nuovo schema con le chiavi pulite dai tag di detail</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonConverter.getSchema"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getSchema">[documenti]</a>    <span class="k">def</span> <span class="nf">getSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iterable</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">new_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iterable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="n">jKey</span><span class="o">.</span><span class="n">real_name</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">new_</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">new_</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterable</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">new_</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
                <span class="n">new_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">new_</span> <span class="o">=</span> <span class="n">iterable</span>
        <span class="k">return</span> <span class="n">new_</span></div>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Crea un nuovo schema con le chiavi pulite dai tag di detail</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonConverter.getSchema_"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getSchema_">[documenti]</a>    <span class="k">def</span> <span class="nf">getSchema_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iterable</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iterable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c1">#new_name = key.lower()</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="n">jKey</span><span class="o">.</span><span class="n">real_name</span>
                <span class="n">iterable</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">iterable</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">new_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">new_name</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                    <span class="n">iterable</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">new_name</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iterable</span><span class="p">)):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSchema</span><span class="p">(</span><span class="n">iterable</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">iterable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">return</span> <span class="n">iterable</span></div>

    <span class="c1"># cast_obj = True.  Lista disomogenea : nella lista degli oggetti restituiti ogni oggetto avra&#39; il tipo identificato nello schema (int) (double) ecc</span>
    <span class="c1"># cast_obj = False. Lista omogenea : nella lista degli oggetti restituiti ogni oggetto sara&#39; di tipo String</span>
    <span class="k">def</span> <span class="nf">__getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_obj</span><span class="p">,</span> <span class="n">json_schema</span><span class="p">,</span> <span class="n">casttype</span><span class="p">):</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1">#for name in json_schema:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">json_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isMandatory</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">JError</span><span class="p">(</span><span class="s2">&quot;Error_1 : </span><span class="si">{}</span><span class="s2"> is mandatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">))</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="c1">#valore di default inserito nel json_schema</span>
                        <span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isForceDefault</span><span class="p">:</span>
                    <span class="c1">#valore di default inserito nel json_schema</span>
                    <span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

                <span class="n">inner_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getData</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span><span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">casttype</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="n">inner_list</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">lines_new</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">data_list_obj</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">inner_list_obj</span> <span class="ow">in</span> <span class="n">inner_list</span> <span class="p">:</span>
                            <span class="n">lines_new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_list_obj</span> <span class="o">+</span> <span class="n">inner_list_obj</span><span class="p">)</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="n">lines_new</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">:</span>
                <span class="n">inner_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getData</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/@&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">json_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">casttype</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="n">data_list</span> <span class="o">=</span> <span class="n">inner_list</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="k">for</span> <span class="n">inner_list_obj</span> <span class="ow">in</span> <span class="n">inner_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isUnion</span> <span class="p">:</span>
                            <span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_UNION_DELIMITER</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">inner_list_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
                        <span class="k">else</span> <span class="p">:</span>
                            <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inner_list_obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">json_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isMandatory</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JError</span><span class="p">(</span><span class="s2">&quot;Error_2 : </span><span class="si">{}</span><span class="s2"> is mandatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">castObj</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="n">jKey</span><span class="p">,</span> <span class="n">casttype</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">obj</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data_list</span>


    <span class="k">def</span> <span class="nf">__getDataJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">json_obj</span><span class="p">,</span> <span class="n">json_schema</span><span class="p">,</span> <span class="n">casttype</span><span class="p">):</span>
        <span class="n">data_json</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="c1">#for name in json_schema:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">json_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
                    <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isMandatory</span> <span class="p">:</span>
                        <span class="k">raise</span> <span class="n">JError</span><span class="p">(</span><span class="s2">&quot;Error_1 : </span><span class="si">{}</span><span class="s2"> is mandatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">))</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="c1">#valore di default inserito nel json_schema</span>
                        <span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isForceDefault</span><span class="p">:</span>
                    <span class="c1">#valore di default inserito nel json_schema</span>
                    <span class="n">data_json</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">data_json</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDataJson</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span><span class="n">json_obj</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">casttype</span><span class="p">)</span>
                     
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">data_json</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">json_obj</span><span class="p">:</span>
                <span class="n">data_json_inner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDataJson</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/@&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span> <span class="n">json_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">casttype</span><span class="p">)</span>
                <span class="n">data_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_json_inner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">json_obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jKey</span><span class="o">.</span><span class="n">isMandatory</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JError</span><span class="p">(</span><span class="s2">&quot;Error_2 : </span><span class="si">{}</span><span class="s2"> is mandatory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">castObj</span><span class="p">(</span><span class="n">json_obj</span><span class="p">,</span> <span class="n">jKey</span><span class="p">,</span> <span class="n">casttype</span><span class="p">)</span>
                <span class="n">data_json</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">return</span> <span class="n">data_json</span>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    restituisce una riga con l&#39;header estratto dallo schema</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="JsonConverter.getSparkSchema"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.getSparkSchema">[documenti]</a>    <span class="k">def</span> <span class="nf">getSparkSchema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shema_detail</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">jKey</span><span class="o">.</span><span class="n">key_name</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">json_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">jKey</span> <span class="o">=</span> <span class="n">JKey</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">json_schema</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">spark_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSparkSchema</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spark_</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">StructType</span> <span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">json_schema</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="c1">#TODO</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSparkSchema</span><span class="p">(</span><span class="n">json_schema</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s2">&quot;@&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;double&#39;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">DoubleType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">TimestampType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">jKey</span><span class="o">.</span><span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;decimal&#39;</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">DecimalType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="k">return</span> <span class="n">StructField</span><span class="p">(</span><span class="n">jKey</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">current_line</span></div>


<div class="viewcode-block" id="JsonConverter.toJson"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.toJson">[documenti]</a>    <span class="k">def</span> <span class="nf">toJson</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getDataJson</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">CAST_DATA_TYPE</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonConverter.toList"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.toList">[documenti]</a>    <span class="k">def</span> <span class="nf">toList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getData</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">CAST_DATA_TYPE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getHeader</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">list</span></div>

<div class="viewcode-block" id="JsonConverter.toCsv"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.toCsv">[documenti]</a>    <span class="k">def</span> <span class="nf">toCsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">quoteFields</span><span class="o">=</span><span class="s2">&quot;smart&quot;</span><span class="p">,</span> <span class="n">lineSeparator</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getData</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">CAST_CSV</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">header</span> <span class="p">:</span>
            <span class="nb">list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getHeader</span><span class="p">())</span>


        <span class="k">return</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">dataToStr</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quoteFields</span><span class="o">=</span><span class="n">quoteFields</span><span class="p">,</span> <span class="n">lineSeparator</span><span class="o">=</span><span class="n">lineSeparator</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonConverter.toDataFrame"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.toDataFrame">[documenti]</a>    <span class="k">def</span> <span class="nf">toDataFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">JsonUtils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">list_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getData</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span><span class="n">CAST_ALL_STRING</span><span class="p">)</span>        
        <span class="n">df</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">list_</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_spark</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        f_list = []</span>
<span class="sd">        for hd in self.header_detail:</span>
<span class="sd">            f_list.append(hd.new_name)</span>
<span class="sd">        R = Row(*f_list)</span>
<span class="sd">        R = Row(*self.getHeader())</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        list.insert(0, self.getHeader(normalize=True))</span>
<span class="sd">        R = Row(*list.pop(0))</span>
<span class="sd">        df = sc.parallelize([R(*r) for r in list]).toDF()</span>
<span class="sd">        </span>
<span class="sd">        for hd in self.header_detail:</span>
<span class="sd">            #if hd.data_type is not &#39;string&#39; :</span>
<span class="sd">            if type(hd.data_type) is not str :</span>
<span class="sd">                df = df.withColumn(hd.new_name, df[hd.new_name].cast(hd.data_type))</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="JsonConverter.toDataFrameFromList"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.JsonConverter.toDataFrameFromList">[documenti]</a>    <span class="k">def</span> <span class="nf">toDataFrameFromList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">list_</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema_spark</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">hd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_detail</span><span class="p">:</span>
            <span class="c1">#if hd.data_type is not &#39;string&#39; :</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">new_name</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">hd</span><span class="o">.</span><span class="n">new_name</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">data_type</span><span class="p">))</span>
        
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        list_.insert(0, self.getHeader(normalize=True))</span>
<span class="sd">        R = Row(*list_.pop(0))</span>
<span class="sd">        df = sc.parallelize([R(*r) for r in list_]).toDF()</span>
<span class="sd">        </span>
<span class="sd">        for hd in self.header_detail:</span>
<span class="sd">            #if hd.data_type is not &#39;string&#39; :</span>
<span class="sd">            if type(hd.data_type) is not str :</span>
<span class="sd">                df = df.withColumn(hd.new_name, df[hd.new_name].cast(hd.data_type))</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">df</span></div></div>


<span class="c1">#########################################</span>
<span class="c1">##########         CSV         ##########</span>
<span class="c1">#########################################</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>


<div class="viewcode-block" id="CsvConverter"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.CsvConverter">[documenti]</a><span class="k">class</span> <span class="nc">CsvConverter</span> <span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_schema</span> <span class="o">=</span> <span class="n">schema</span>


<div class="viewcode-block" id="CsvConverter.toList"><a class="viewcode-back" href="../../ingestion.html#ingestion.converter.CsvConverter.toList">[documenti]</a>    <span class="k">def</span> <span class="nf">toList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">csv_header</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
        <span class="n">header_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_schema</span><span class="p">:</span>
            <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">data_</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">csv_header</span> <span class="p">:</span>
            <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">csv_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">header_list</span><span class="p">)</span>

        <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">csv_content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv_reader</span><span class="p">:</span>
            <span class="n">csv_line</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_schema</span> <span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">row</span> <span class="p">:</span>
                    <span class="n">csv_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">csv_line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">csv_content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csv_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span> <span class="p">:</span>
            <span class="n">csv_content</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header_list</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">csv_content</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">PAT</a></h1>








<h3>Navigazione</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Codice del modulo</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Ricerca veloce</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Vai" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Giuseppe Ventura.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.5.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>